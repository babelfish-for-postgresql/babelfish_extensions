name: Version Upgrade Test Framework
on:
  push:
    branches:
      - BABEL_2_X_DEV_upgrade_test
  pull_request:
    branches:
      - BABEL_2_X_DEV_upgrade_test

jobs:
  version-upgrade-tests:
    name: Upgrade version and test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Install Dependencies
        id: install-dependencies
        if: always()
        uses: ./.github/composite-actions/install-dependencies

      - name: Install yq - yaml parser
        id: install-yq
        if: always()
        run: pip3 install yq

      - name: read base version
        id: read-base-version
        if: always() && steps.install-yq.outcome == 'success'
        run: > 
          echo "::set-output name=base-version::$(
            yq '."upgrade-version"[0]' ${{ github.workspace }}/.github/configuration/upgrade-test-configuration.yml
          )"

      - name: find-branch
        id: find-branch
        if: always() && steps.read-base-version.outcome == 'success'
        run: >
          echo "::set-output name=base-engine-branch::$(
            yq -r '."${{ steps.read-base-version.outputs.base-version }}".engine_branch' ${{ github.workspace }}/.github/template/version-branch-template.yml
          )" &&
          echo "::set-output name=base-extension-branch::$(
            yq -r '."${{ steps.read-base-version.outputs.base-version }}".extension_branch' ${{ github.workspace }}/.github/template/version-branch-template.yml
          )"

      - name: Setup Base Version and Runs Tests
        id: setup-base-version
        timeout-minutes: 30
        if: always() && steps.install-dependencies.outcome == 'success' && steps.find-branch.outcome == 'success'
        uses: ./.github/composite-actions/setup-base-version
        with:
          engine_branch: ${{ steps.find-branch.outputs.base-engine-branch }}
          extension_branch: ${{ steps.find-branch.outputs.base-extension-branch }}

      - name: read next upgrade version
        id: read-next-upgrade-version
        if: always() && steps.install-yq.outcome == 'success'
        run: > 
          echo "::set-output name=next-version::$(
            yq '."upgrade-version"[1]' ${{ github.workspace }}/.github/configuration/upgrade-test-configuration.yml
          )"

      - name: find branch of next version
        id: find-branch-next-version
        if: always() && steps.read-next-upgrade-version.outcome == 'success'
        run: >
          echo "::set-output name=next-engine-branch::$(
            yq -r '."${{ steps.read-next-upgrade-version.outputs.next-version }}".engine_branch' ${{ github.workspace }}/.github/template/version-branch-template.yml
          )" &&
          echo "::set-output name=next-extension-branch::$(
            yq -r '."${{ steps.read-next-upgrade-version.outputs.next-version }}".extension_branch' ${{ github.workspace }}/.github/template/version-branch-template.yml
          )"

      - name: Upgrade Version
        id: upgrade-version
        timeout-minutes: 30
        if: always() && steps.find-branch-next-version.outcome == 'success' && steps.setup-base-version.outcome == 'success'
        uses: ./.github/composite-actions/upgrade-version
        with: 
          engine_branch: ${{ steps.find-branch-next-version.outputs.next-engine-branch }}
          extension_branch: ${{ steps.find-branch-next-version.outputs.next-extension-branch }}
          is_final_ver: true

      - name: Upload Log
        if: always() && steps.upgrade-version.outcome == 'failure'
        uses: actions/upload-artifact@v2
        with:
          name: postgres-log
          path: ~/postgres/data/logfile

      # The test summary files contain paths with ':' characters, which is not allowed with the upload-artifact actions
      - name: Rename Test Summary Files
        id: test-file-rename
        if: always() && steps.upgrade-version.outcome == 'failure'
        run: |
          cd test/JDBC/Info
          timestamp=`ls -Art | tail -n 1`
          cd $timestamp
          mv $timestamp.diff ../output-diff.diff
          mv "$timestamp"_runSummary.log ../run-summary.log

      - name: Upload Run Summary 
        if: always() && steps.test-file-rename == 'success'
        uses: actions/upload-artifact@v2
        with:
          name: run-summary.log
          path: test/JDBC/Info/run-summary.log

      - name: Upload Output Diff
        if: always() && steps.upgrade-version.outcome == 'failure'
        uses: actions/upload-artifact@v2
        with:
          name: output-diff.diff
          path: test/JDBC/Info/output-diff.diff