name: 'Build pgaudit Extension'

inputs:
  install_dir:
    description: 'Engine install directory'
    required: no
    default: psql

runs:
  using: "composite"
  steps:
    - name: Build pgaudit Extension
      run: |
        cd ..
        rm -rf pgaudit
        sudo apt-get install -y git make gcc
        git clone https://github.com/pgaudit/pgaudit.git
        cd pgaudit
        make
        sudo make install
        sudo ~/${{ inputs.install_dir }}/bin/psql -h localhost -U postgres -d postgres -c "CREATE EXTENSION pgaudit;"
        sudo ~/${{ inputs.install_dir }}/bin/psql -h localhost -U postgres -d postgres -c "ALTER SYSTEM SET pgaudit.log = 'all';"
        sudo ~/${{ inputs.install_dir }}/bin/pg_ctl -D ~/${{ inputs.install_dir }}/data restart
      shell: bash