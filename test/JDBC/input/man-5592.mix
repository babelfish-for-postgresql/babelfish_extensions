-- migrate test man-5592 to to test prallel query

-- tsql
SELECT set_config('max_parallel_workers_per_gather', 8, false);
GO

CREATE TABLE man5592_t (id BIGINT, val DOUBLE PRECISION);
GO
INSERT INTO man5592_t
  SELECT * FROM (
    SELECT generate_series(1, 500000) AS id, random() AS val
  ) q ORDER BY random();
GO
CREATE INDEX man5592_unique ON man5592_t(id);
GO

-- psql
VACUUM ANALYZE master_dbo.man5592_t;
GO

-- Manfred-7171: Test temp-TABLE read concurrent with non-temp TABLE prefetch.
-- tsql
CREATE TABLE #man5592_temp_t (id bigint);
GO
INSERT INTO #man5592_temp_t SELECT id FROM man5592_t;
GO
DROP TABLE #man5592_temp_t;
GO

SELECT set_config('enable_seqscan', 'on', false);
SELECT set_config('enable_indexscan', 'on', false);
SELECT set_config('enable_bitmapscan', 'on', false);
GO

-- [MAN-5552] heap scans
SELECT SUM(id) FROM man5592_t;
GO
SELECT COUNT(val) FROM man5592_t;
GO
SELECT SUM(id) FROM man5592_t WHERE id > 1000 and id < 99999;
GO

-- [MAN-2626] index-only and index (+heap) scans
-- force scans to use our index.
SELECT set_config('enable_seqscan', 'off', false);
SELECT set_config('enable_bitmapscan', 'off', false);
GO

-- [MAN-2626] index-only scan, large range
SELECT SUM(id) FROM man5592_t WHERE id > 5000;
GO
SELECT COUNT(id) FROM man5592_t WHERE id < 495000;
GO

-- [MAN-2626] index-only scan, medium range
SELECT COUNT(id) FROM man5592_t WHERE id > 30000;
GO
SELECT SUM(id) FROM man5592_t WHERE id < 30000;
GO

-- [MAN-2626] index-only scan, small range
SELECT COUNT(id) FROM man5592_t WHERE id > 495000;
GO
SELECT COUNT(id) FROM man5592_t WHERE id < 5000;
GO

-- [MAN-2626] index-only scan, backward, large range
SELECT COUNT(col) FROM
  (SELECT id AS col FROM man5592_t WHERE id > 5000 GROUP BY id ORDER BY id DESC) tab;
GO

-- [MAN-2626] index-only scan, backward, small range
SELECT COUNT(col) FROM
  (SELECT id AS col FROM man5592_t WHERE id > 495000 GROUP BY id ORDER BY id DESC) tab;
GO
SELECT COUNT(col) FROM
  (SELECT id AS col FROM man5592_t WHERE id < 5000 GROUP BY id ORDER BY id DESC) tab;
GO

-- [MAN-2626] index-only scan, whole index
SELECT COUNT(id) FROM man5592_t;
GO

-- [MAN-2626] index scan, large range
SELECT COUNT(val) FROM man5592_t WHERE id > 5000;
GO
SELECT COUNT(val) FROM man5592_t WHERE id < 495000;
GO

-- [MAN-2626] index scan, medium range
SELECT COUNT(val) FROM man5592_t WHERE id > 30000;
GO
SELECT COUNT(val) FROM man5592_t WHERE id < 30000;
GO

-- [MAN-2626] index scan, small range
SELECT COUNT(val) FROM man5592_t WHERE id > 495000;
GO
SELECT COUNT(val) FROM man5592_t WHERE id < 5000;
GO

-- [MAN-7161] index scan, in-list
SELECT COUNT(val) FROM man5592_t
WHERE id IN (1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000, 9000, 10000,
      11000, 12000, 13000, 14000, 15000, 16000, 17000, 18000, 19000, 20000,
      21000, 22000, 23000, 24000, 25000, 26000, 27000, 28000, 29000, 30000,
      31000, 32000, 33000, 34000, 35000, 36000, 37000, 38000, 39000, 40000,
      500000, 450000, 400000, 350000, 300000, 250000, 200000, 150000, 100000);
GO

-- [MAN-7589] bitmap heap scans
SELECT set_config('enable_seqscan', 'off', false);
SELECT set_config('enable_indexscan', 'off', false);
SELECT set_config('enable_bitmapscan', 'on', false);
GO
SELECT SUM(id) FROM man5592_t WHERE id > 5000;
GO
SELECT COUNT(id) FROM man5592_t WHERE id < 495000;
GO

DROP INDEX IF EXISTS man5592_unique ON man5592_t;
GO
CREATE INDEX man8040_index ON man5592_t(id);
GO

-- psql
VACUUM ANALYZE master_dbo.man5592_t;
GO

-- tsql
SELECT set_config('enable_seqscan', 'off', false);
SELECT set_config('enable_indexscan', 'on', false);
SELECT set_config('enable_bitmapscan', 'off', false);
SELECT SUM(id), COUNT(val) FROM man5592_t WHERE id > 5000;
GO

-- Cleanup
DROP INDEX IF EXISTS man8040_index ON man5592_t;
DROP TABLE IF EXISTS man5592_t;
GO
