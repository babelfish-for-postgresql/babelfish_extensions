-- tsql user=db_roles_l2 password=123
-- create objects after upgrade
use db_roles_db1;
go

create table db_roles_schema_2.after_created_by_u2_t1(a int);
go

create view db_roles_schema_2.after_created_by_u2_v1 as select 1;
go

use master;
go

-- tsql
use db_roles_db1
go

create table db_roles_schema_1.after_t1(a int);
go

create view db_roles_schema_1.after_v1 as select 2;
go

create table db_roles_schema_2.after_created_by_dbo_t1(a int);
go

create view db_roles_schema_2.after_created_by_dbo_v1 as select 2;
go

alter role db_datareader add member db_roles_u1;
go

alter role db_datawriter add member db_roles_u1;
go

create table db_roles_schema_1.after_t2(a int);
go

create view db_roles_schema_1.after_v2 as select 2;
go

create table db_roles_schema_2.after_created_by_dbo_t2(a int);
go

create view db_roles_schema_2.after_created_by_dbo_v2 as select 2;
go

use master
go

-- tsql user=db_roles_l2 password=123
use db_roles_db1;
go

create table db_roles_schema_2.after_created_by_u2_t2(a int);
go

create view db_roles_schema_2.after_created_by_u2_v2 as select 1;
go

use master;
go

-- tsql user=db_roles_l1 password=123
use db_roles_db1
go

-- user is a member of db_datareader/db_datawriter, objects should be accessible
select * from db_roles_schema_1.after_t1; -- allowed
go

select * from db_roles_schema_1.after_t2; -- allowed
go

select * from db_roles_schema_1.after_v1; -- allowed
go

select * from db_roles_schema_1.after_v2; -- allowed
go

insert into db_roles_schema_1.before_t1 values(1); -- allowed
go

update db_roles_schema_1.before_t1 set a = 2 where a = 1; -- allowed
go

delete from db_roles_schema_1.before_t1 where a = 2; -- allowed
go

select * from db_roles_schema_2.before_created_by_dbo_t1; -- allowed
go

select * from db_roles_schema_2.before_created_by_dbo_v1; -- allowed
go

insert into db_roles_schema_2.before_created_by_dbo_t1 values(1); -- allowed
go

update db_roles_schema_2.before_created_by_dbo_t1 set a = 2 where a = 1; -- allowed
go

delete from db_roles_schema_2.before_created_by_dbo_t1 where a = 2; -- allowed
go

select * from db_roles_schema_2.after_created_by_dbo_t1; -- allowed
go

select * from db_roles_schema_2.after_created_by_dbo_v1; -- allowed
go

insert into db_roles_schema_2.after_created_by_dbo_t1 values(1); -- allowed
go

update db_roles_schema_2.after_created_by_dbo_t1 set a = 2 where a = 1; -- allowed
go

delete from db_roles_schema_2.after_created_by_dbo_t1 where a = 2; -- allowed
go

select * from db_roles_schema_2.after_created_by_dbo_t2; -- allowed
go

select * from db_roles_schema_2.after_created_by_dbo_v2; -- allowed
go

insert into db_roles_schema_2.after_created_by_dbo_t2 values(1); -- allowed
go

update db_roles_schema_2.after_created_by_dbo_t2 set a = 2 where a = 1; -- allowed
go

delete from db_roles_schema_2.after_created_by_dbo_t2 where a = 2; -- allowed
go

select * from db_roles_schema_2.before_created_by_u2_t1; -- allowed
go

select * from db_roles_schema_2.before_created_by_u2_v1; -- allowed
go

insert into db_roles_schema_2.before_created_by_u2_t1 values(1); -- allowed
go

update db_roles_schema_2.before_created_by_u2_t1 set a = 2 where a = 1; -- allowed
go

delete from db_roles_schema_2.before_created_by_u2_t1 where a = 2; -- allowed
go

select * from db_roles_schema_2.after_created_by_u2_t2; -- allowed
go

select * from db_roles_schema_2.after_created_by_u2_v2; -- allowed
go

insert into db_roles_schema_2.after_created_by_u2_t2 values(1); -- allowed
go

update db_roles_schema_2.after_created_by_u2_t2 set a = 2 where a = 1; -- allowed
go

delete from db_roles_schema_2.after_created_by_u2_t2 where a = 2; -- allowed
go

select * from db_roles_schema_2.after_created_by_u2_t1; -- allowed
go

select * from db_roles_schema_2.after_created_by_u2_v1; -- allowed
go

insert into db_roles_schema_2.after_created_by_u2_t1 values(1); -- allowed
go

update db_roles_schema_2.after_created_by_u2_t1 set a = 2 where a = 1; -- allowed
go

delete from db_roles_schema_2.after_created_by_u2_t1 where a = 2; -- allowed
go

use master;
go

-- tsql
use db_roles_db1;
go

alter role db_datareader drop member db_roles_u1;
go

alter role db_datawriter drop member db_roles_u1;
go

use master;
go

-- tsql user=db_roles_l1 password=123
use db_roles_db1;
go

select * from db_roles_schema_1.after_t1;  -- not allowed
go

select * from db_roles_schema_1.after_t2;  -- not allowed
go

select * from db_roles_schema_1.before_t1; -- not allowed
go

select * from db_roles_schema_1.after_v1;  -- not allowed
go

select * from db_roles_schema_1.after_v2;  -- not allowed
go

select * from db_roles_schema_1.before_v1; -- not allowed
go

insert into db_roles_schema_1.before_t1 values(1); -- not allowed
go

update db_roles_schema_1.before_t1 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_1.before_t1 where a = 2; -- not allowed
go

insert into db_roles_schema_1.after_t1 values(1); -- not allowed
go

update db_roles_schema_1.after_t1 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_1.after_t1 where a = 2; -- not allowed
go

insert into db_roles_schema_1.after_t2 values(1); -- not allowed
go

update db_roles_schema_1.after_t2 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_1.after_t2 where a = 2; -- not allowed
go

select * from db_roles_schema_2.before_created_by_dbo_t1; -- not allowed
go

select * from db_roles_schema_2.before_created_by_dbo_v1; -- not allowed
go

insert into db_roles_schema_2.before_created_by_dbo_t1 values(1); -- not allowed
go

update db_roles_schema_2.before_created_by_dbo_t1 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_2.before_created_by_dbo_t1 where a = 2; -- not allowed
go

select * from db_roles_schema_2.after_created_by_dbo_t1; -- not allowed
go

select * from db_roles_schema_2.after_created_by_dbo_v1; -- not allowed
go

insert into db_roles_schema_2.after_created_by_dbo_t1 values(1); -- not allowed
go

update db_roles_schema_2.after_created_by_dbo_t1 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_2.after_created_by_dbo_t1 where a = 2; -- not allowed
go

select * from db_roles_schema_2.after_created_by_dbo_t2; -- not allowed
go

select * from db_roles_schema_2.after_created_by_dbo_v2; -- not allowed
go

insert into db_roles_schema_2.after_created_by_dbo_t2 values(1); -- not allowed
go

update db_roles_schema_2.after_created_by_dbo_t2 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_2.after_created_by_dbo_t2 where a = 2; -- not allowed
go

select * from db_roles_schema_2.before_created_by_u2_t1; -- not allowed
go

select * from db_roles_schema_2.before_created_by_u2_v1; -- not allowed
go

insert into db_roles_schema_2.before_created_by_u2_t1 values(1); -- not allowed
go

update db_roles_schema_2.before_created_by_u2_t1 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_2.before_created_by_u2_t1 where a = 2; -- not allowed
go

select * from db_roles_schema_2.after_created_by_u2_t1; -- not allowed
go

select * from db_roles_schema_2.after_created_by_u2_v1; -- not allowed
go

insert into db_roles_schema_2.after_created_by_u2_t1 values(1); -- not allowed
go

update db_roles_schema_2.after_created_by_u2_t1 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_2.after_created_by_u2_t1 where a = 2; -- not allowed
go

select * from db_roles_schema_2.after_created_by_u2_t2; -- not allowed
go

select * from db_roles_schema_2.after_created_by_u2_v2; -- not allowed
go

insert into db_roles_schema_2.after_created_by_u2_t2 values(1); -- not allowed
go

update db_roles_schema_2.after_created_by_u2_t2 set a = 2 where a = 1; -- not allowed
go

delete from db_roles_schema_2.after_created_by_u2_t2 where a = 2; -- not allowed
go

use master;
go
