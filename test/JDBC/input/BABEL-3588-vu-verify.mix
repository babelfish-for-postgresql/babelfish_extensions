-- Test enable_pg_hint
-- psql
analyze master_dbo.babel_3588_t1;
go

analyze master_dbo.babel_3588_t2;
go

-- tsql
exec sp_babelfish_configure 'babelfishpg_tsql.explain_costs', 'off'
GO

set babelfish_showplan_all on;
go

-- expect merge join
exec babel_3588_proc_1;
go

set babelfish_showplan_all off;
go

exec sp_babelfish_configure 'enable_pg_hint', 'off'
go

set babelfish_showplan_all on;
go

-- expect merge join because of plan caching
exec babel_3588_proc_1;
go

-- expect nested loop join
SELECT babel_3588_t1.a1 FROM babel_3588_t1 inner merge join babel_3588_t2 ON a1 = b2;
go

set babelfish_showplan_all off;
go

-- clean up
drop procedure babel_3588_proc_1;
go
drop table babel_3588_t1;
go
drop table babel_3588_t2;
go

exec sp_babelfish_configure 'enable_pg_hint', 'on', 'server'
go

-- Set all Gucs back to default value
EXEC sp_babelfish_configure '%','default'
GO

-- Default value is on
SELECT CURRENT_SETTING('babelfishpg_tsql.explain_costs')
GO

-- Explain Gucs can set to on or off
EXEC sp_babelfish_configure 'babelfishpg_tsql.explain_costs','off','server'
GO

-- Should set to off
SELECT CURRENT_SETTING('babelfishpg_tsql.explain_costs')
GO

-- Should set all Gucs to default value
EXEC sp_babelfish_configure '%','default'
GO

-- Default value is on
SELECT CURRENT_SETTING('babelfishpg_tsql.explain_costs')
GO

-- Should throw error when trying to set to arbirary value
EXEC sp_babelfish_configure 'babelfishpg_tsql.explain_costs','eee'
GO

-- Should throw an error
EXEC sp_babelfish_configure '%', 'on'
GO

-- Set all escape hatch to strict
EXEC sp_babelfish_configure '%', 'strict', 'server';
GO
select count(*) FROM pg_catalog.pg_settings WHERE name collate "C" like 'babelfishpg_tsql.escape_%' and setting collate "C" != 'strict';
GO

-- Set all escape hatch to ignore
EXEC sp_babelfish_configure '%', 'ignore', 'server';
GO
select count(*) FROM pg_catalog.pg_settings WHERE name collate "C" like 'babelfishpg_tsql.escape_%' and setting collate "C" != 'ignore';
GO

-- Set all GUCs back to default values
EXEC sp_babelfish_configure '%', 'default', 'server'
GO
