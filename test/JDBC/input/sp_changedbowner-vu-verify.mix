-- sp_changedbowner: this is a subset of the tests for C:\Babelfish\code\work\chgdbowner\alter_authorization_change_db_owner

-- tsql
use master
go
create login new_OWNER_login with password='12345678'
go
create login new_OWNER_login2 with password='12345678'
go
create login [new_OWNER_login3] with password='12345678'
go
create login [new_OWNER_login 4] with password='12345678'
go
set quoted_identifier on
go
create login "new_OWNER_login5" with password='12345678'
go
create login "new_OWNER_login 6" with password='12345678'
go
set quoted_identifier off
go

-- system database ownership cannot be changed
use master
go
execute sp_changedbowner 'new_owner_login'
go
use tempdb
go
execute sp_changedbowner 'new_owner_login'
go

-- except for msdb
use msdb
go
declare @orig_owner sysname 
select @orig_owner = suser_sname(sid) from sysdatabases where name = 'msdb'
execute sp_changedbowner new_owner_login
select name, suser_sname(sid) from sysdatabases where name = 'msdb'
execute sp_changedbowner @orig_owner
select name, suser_sname(sid) from sysdatabases where name = 'msdb'
go


create database change_OWNER_db_sp
go
use change_owner_DB_SP
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner 'no_such_login'
go

-- new owner cannot be a user in the DB already
create user new_owner_login
go
execute sp_changedbowner new_owner_login
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
drop user new_owner_login
go
execute sp_changedbowner new_owner_LOGIN
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go

-- tsql user=new_owner_LOGIN password=12345678
use CHANGE_OWNER_DB_SP
go
select user_name(), db_name()
go
use master
go

-- tsql 
-- second argument is ignored
use change_owner_db_sp
go
execute sp_changedbowner NEW_owner_login2, null
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner [new_owner_LOGIN3], 12345
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner [NEW_owner_login3], 'abcde'
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner [new_owner_LOGIN 4], 'abcdefgh'
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner "NEW_owner_login5"
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner @loginame = "new_owner_LOGIN 6", @map = 'some-string'
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go

use change_owner_db_sp
go
execute sp_changedbowner "new_owner_login"
go
use master
go

-- change owner to yourself
-- tsql user=new_owner_LOGIN password=12345678
use change_owner_db_sp
go
select user_name(), db_name()
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner "new_owner_login"
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner "NEW_OWNER_LOGIN"
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner [NEW_owner_login]
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
use master
go

-- tsql 
-- roll back owner change in transaction
use change_owner_db_sp
go
begin tran
go
select 'before owner change', name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner NEW_owner_login2
go
select 'after owner change', name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
rollback
go
select 'after rollback', name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go


-- NULL as new owner is a no-op
execute sp_changedbowner NULL
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go
execute sp_changedbowner @loginame=NULL
go
select name, suser_sname(sid) from sysdatabases where lower(name) = 'change_owner_db_sp'
go

-- non-existing logins
execute sp_changedbowner ''
go
execute sp_changedbowner ' '
go
execute sp_changedbowner @loginame=' '
go
execute sp_changedbowner [ ]
go
execute sp_changedbowner @loginame=[ ]
go
use master
go
drop database change_owner_db_sp
go

-- tests for long names and mixed case
create login    LOGIN63long_345678901234567890123456789012345678901234567890123 with password = '12345678'
go
create database DB63long_012345678901234567890123456789012345678901234567890123
go
use DB63long_012345678901234567890123456789012345678901234567890123
go
execute sp_changedbowner LOGIN63long_345678901234567890123456789012345678901234567890123
go
select name, suser_sname(sid) from sysdatabases where upper(name) like 'DB63LONG%'
go
use master
go

-- tsql user=LOGIN63long_345678901234567890123456789012345678901234567890123 password=12345678
use DB63long_012345678901234567890123456789012345678901234567890123
go
select user_name(), db_name()
go
use master
go
drop database DB63long_012345678901234567890123456789012345678901234567890123
go

-- tsql
create login    LOGIN64long_3456789012345678901234567890123456789012345678901234 with password = '12345678'
go
create database DB64long_0123456789012345678901234567890123456789012345678901234
go
use DB64long_0123456789012345678901234567890123456789012345678901234
go
-- this returns 'principal not found' due to a bug in SUSER_ID() for names > 63 chars
execute sp_changedbowner "LOGIN64long_3456789012345678901234567890123456789012345678901234"
go
select name, suser_sname(sid) from sysdatabases where upper(name) like 'DB64LONG%'
go
use master
go
drop database DB64long_0123456789012345678901234567890123456789012345678901234
go

use master
go
set nocount on
go
-- kill remaining sessions
create table #killed(killed int)
go
declare @spid int, @cmd varchar(30)
while (1=1)
begin 
select @spid = spid from sys.sysprocesses where spid <> @@spid and spid not in (select killed from #killed)
if @@rowcount = 0 break
insert #killed values(@spid)
set @cmd = 'kill ' + convert(varchar, @spid)
execute(@cmd)
end
go

-- cleanup
use master
go
drop login new_owner_login 
go
drop login new_owner_login2 
go
drop login [new_owner_login3] 
go
drop login [new_owner_login 4] 
go
set quoted_identifier on
go
drop login "new_owner_login5" 
go
drop login "new_owner_login 6" 
go
set quoted_identifier off
go
drop login LOGIN64long_3456789012345678901234567890123456789012345678901234 
go
drop login LOGIN63long_345678901234567890123456789012345678901234567890123 
go