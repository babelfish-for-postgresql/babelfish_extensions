-- Setup
CREATE DATABASE sys_sql_modules_vu_prepare_db
GO

CREATE VIEW sys_sql_modules_vu_prepare_v1 AS -- This view should not be seen as we will be using a different database for the test
SELECT 1
GO

USE sys_sql_modules_vu_prepare_db
GO

CREATE TABLE sys_sql_modules_vu_prepare_t1(a int)
GO

CREATE TABLE sys_sql_modules_vu_prepare_t2(a int)
GO

CREATE TRIGGER sys_sql_modules_vu_prepare_tr1 ON sys_sql_modules_vu_prepare_t2 INSTEAD OF INSERT
AS
BEGIN
SELECT * FROM sys_sql_modules_vu_prepare_t1;
END
GO

CREATE VIEW sys_sql_modules_vu_prepare_v2 AS
SELECT 1
GO

CREATE FUNCTION sys_sql_modules_vu_prepare_f1() 
RETURNS INT
AS 
BEGIN
    RETURN 1;
END
GO

CREATE PROC sys_sql_modules_vu_prepare_p1 AS
SELECT 1
GO

-- Test permission for all_sql_modules (query should not have any results)
CREATE LOGIN sys_sql_modules_vu_prepare_user WITH PASSWORD='test'
GO

CREATE USER sys_sql_modules_vu_prepare_user FOR LOGIN sys_sql_modules_vu_prepare_user
GO

-- Test for function
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE definition LIKE 'CREATE FUNCTION dbo.sys_sql_modules_vu_prepare_f1()%'
GO

-- Test for views
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE object_id = OBJECT_ID('sys_sql_modules_vu_prepare_v2')
GO

-- Test for triggers
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE object_id = (SELECT TOP(1) object_id FROM sys.objects WHERE name = 'sys_sql_modules_vu_prepare_tr1')
GO

-- Test for proc
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE definition = 'CREATE PROCEDURE dbo.sys_sql_modules_vu_prepare_p1 AS SELECT 1'
GO

-- Test for system function
SELECT
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE object_id = OBJECT_ID('sys.fn_listextendedproperty')
GO

-- Test for system views
SELECT
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE object_id = OBJECT_ID('sys.tables')
GO

-- Test for system proc
SELECT
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE object_id = OBJECT_ID('sys.sp_tables')
GO

-- Test that sys.sql_modules is database-scoped
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE object_id = OBJECT_ID('sys_sql_modules_vu_prepare_v1')
GO

USE master
GO

-- tsql user=sys_sql_modules_vu_prepare_user password=test

USE sys_sql_modules_vu_prepare_db
GO

SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.sql_modules
WHERE definition = 'CREATE PROCEDURE dbo.sys_sql_modules_vu_prepare_p1 AS SELECT 1'
GO

USE master
GO

-- psql
-- Need to terminate active session before cleaning up the login
SELECT pg_terminate_backend(pid) FROM pg_stat_get_activity(NULL) 
WHERE sys.suser_name(usesysid) = 'sys_sql_modules_vu_prepare_user' AND backend_type = 'client backend' AND usesysid IS NOT NULL;
GO

-- tsql
USE sys_sql_modules_vu_prepare_db
GO

DROP LOGIN sys_sql_modules_vu_prepare_user
GO

-- Cleanup
DROP PROC sys_sql_modules_vu_prepare_p1
GO

DROP TRIGGER sys_sql_modules_vu_prepare_tr1
GO

DROP TABLE sys_sql_modules_vu_prepare_t1
GO

DROP TABLE sys_sql_modules_vu_prepare_t2
GO

DROP VIEW sys_sql_modules_vu_prepare_v2
GO

DROP FUNCTION sys_sql_modules_vu_prepare_f1
GO

USE master
GO

DROP VIEW sys_sql_modules_vu_prepare_v1
GO

DROP DATABASE sys_sql_modules_vu_prepare_db
GO
