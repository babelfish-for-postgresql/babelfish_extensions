-- expression as column
SELECT STRING_AGG(a,'-') FROM string_agg_t
GO
~~START~~
text
c-b-g-a-e-d-h
~~END~~


SELECT STRING_AGG(a,'-') FROM string_agg_t GROUP BY g
GO
~~START~~
text
b-g-e
c-a-d-h
~~END~~


SELECT STRING_AGG(a,'-') WITHIN GROUP (ORDER BY sbid) FROM string_agg_t GROUP BY g
GO
~~START~~
text
h-d-c-a
e-g-b
~~END~~


SELECT STRING_AGG(a,'-') WITHIN GROUP (ORDER BY sbid ASC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
h-d-c-a
e-g-b
~~END~~


SELECT STRING_AGG(a,'-') WITHIN GROUP (ORDER BY sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
a-c-d-h
b-g-e
~~END~~


SELECT STRING_AGG(a,'-') WITHIN GROUP (ORDER BY id, sbid ASC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
a-c-h-d
g-b-e
~~END~~


SELECT STRING_AGG(a,'-') WITHIN GROUP (ORDER BY id, sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
a-c-d-h
b-g-e
~~END~~


-- expression as expression of multiple columns
SELECT STRING_AGG(a+b,'-') FROM string_agg_t
GO
~~START~~
text
cx-by-gu-az-ev-dw-ht
~~END~~


SELECT STRING_AGG(a+b,'-') FROM string_agg_t GROUP BY g
GO
~~START~~
text
by-gu-ev
cx-az-dw-ht
~~END~~


SELECT STRING_AGG(a+b,'-') WITHIN GROUP (ORDER BY sbid) FROM string_agg_t GROUP BY g
GO
~~START~~
text
ht-dw-cx-az
ev-gu-by
~~END~~


SELECT STRING_AGG(a+b,'-') WITHIN GROUP (ORDER BY sbid ASC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
ht-dw-cx-az
ev-gu-by
~~END~~


SELECT STRING_AGG(a+b,'-') WITHIN GROUP (ORDER BY sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
az-cx-dw-ht
by-gu-ev
~~END~~


SELECT STRING_AGG(a+b,'-') WITHIN GROUP (ORDER BY id, sbid ASC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
az-cx-ht-dw
gu-by-ev
~~END~~


SELECT STRING_AGG(a+b,'-') WITHIN GROUP (ORDER BY id, sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
az-cx-dw-ht
by-gu-ev
~~END~~


-- expression as function
SELECT STRING_AGG(concat(a,b),'-') FROM string_agg_t
GO
~~START~~
text
cx-by-gu-az-ev-dw-ht
~~END~~


SELECT STRING_AGG(concat(a,b),'-') FROM string_agg_t GROUP BY g
GO
~~START~~
text
by-gu-ev
cx-az-dw-ht
~~END~~


SELECT STRING_AGG(concat(a,b),'-') WITHIN GROUP (ORDER BY sbid) FROM string_agg_t GROUP BY g
GO
~~START~~
text
ht-dw-cx-az
ev-gu-by
~~END~~


SELECT STRING_AGG(concat(a,b),'-') WITHIN GROUP (ORDER BY sbid ASC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
ht-dw-cx-az
ev-gu-by
~~END~~


SELECT STRING_AGG(concat(a,b),'-') WITHIN GROUP (ORDER BY sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
az-cx-dw-ht
by-gu-ev
~~END~~


SELECT STRING_AGG(concat(a,b),'-') WITHIN GROUP (ORDER BY id, sbid ASC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
az-cx-ht-dw
gu-by-ev
~~END~~


SELECT STRING_AGG(concat(a,b),'-') WITHIN GROUP (ORDER BY id, sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
az-cx-dw-ht
by-gu-ev
~~END~~


-- Delimeter as a function
SELECT STRING_AGG(a, char(10)) FROM string_agg_t
GO
~~START~~
text
c<newline>b<newline>g<newline>a<newline>e<newline>d<newline>h
~~END~~


SELECT STRING_AGG(a, char(10)) FROM string_agg_t GROUP BY g
GO
~~START~~
text
b<newline>g<newline>e
c<newline>a<newline>d<newline>h
~~END~~


SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY sbid) FROM string_agg_t GROUP BY g
GO
~~START~~
text
h<newline>d<newline>c<newline>a
e<newline>g<newline>b
~~END~~


SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY sbid ASC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
h<newline>d<newline>c<newline>a
e<newline>g<newline>b
~~END~~


SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
a<newline>c<newline>d<newline>h
b<newline>g<newline>e
~~END~~


SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY id, sbid ASC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
a<newline>c<newline>h<newline>d
g<newline>b<newline>e
~~END~~


SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY id, sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
a<newline>c<newline>d<newline>h
b<newline>g<newline>e
~~END~~


-- Batch statements
SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY sbid) FROM string_agg_t GROUP BY g
SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY sbid ASC) FROM string_agg_t GROUP BY g
SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY sbid DESC) FROM string_agg_t GROUP BY g
SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY id, sbid ASC) FROM string_agg_t GROUP BY g
SELECT STRING_AGG(a, char(10)) WITHIN GROUP (ORDER BY id, sbid DESC) FROM string_agg_t GROUP BY g
GO
~~START~~
text
h<newline>d<newline>c<newline>a
e<newline>g<newline>b
~~END~~

~~START~~
text
h<newline>d<newline>c<newline>a
e<newline>g<newline>b
~~END~~

~~START~~
text
a<newline>c<newline>d<newline>h
b<newline>g<newline>e
~~END~~

~~START~~
text
a<newline>c<newline>h<newline>d
g<newline>b<newline>e
~~END~~

~~START~~
text
a<newline>c<newline>d<newline>h
b<newline>g<newline>e
~~END~~


-- Dependent objects
SELECT * FROM string_agg_dep_v1
GO
~~START~~
text
c-b-g-a-e-d-h
~~END~~


EXEC string_agg_dep_p1
GO
~~START~~
text
c-b-g-a-e-d-h
~~END~~


SELECT dbo.string_agg_dep_f1()
GO
~~START~~
nvarchar
c-b-g-a-e-d-h
~~END~~


SELECT * FROM string_agg_dep_v2
GO
~~START~~
text
b-g-e
c-a-d-h
~~END~~


EXEC string_agg_dep_p2
GO
~~START~~
text
b-g-e
c-a-d-h
~~END~~


SELECT * FROM dbo.string_agg_dep_f2()
GO
~~START~~
text
b-g-e
c-a-d-h
~~END~~


SELECT * FROM string_agg_dep_v3
GO
~~START~~
text
h-d-c-a
e-g-b
~~END~~


EXEC string_agg_dep_p3
GO
~~START~~
text
h-d-c-a
e-g-b
~~END~~


SELECT * FROM dbo.string_agg_dep_f3()
GO
~~START~~
text
h-d-c-a
e-g-b
~~END~~


-- dependent object trigger
INSERT INTO string_agg_order_school (classID, rollID, studentName)
VALUES (2, 3, 'StudentF');
GO
~~START~~
int#!#text
1#!#StudentA, StudentB, StudentC
2#!#StudentD, StudentE, StudentF
~~END~~

~~ROW COUNT: 1~~


UPDATE string_agg_order_school
SET studentName = 'StudentG'
WHERE classID = 2 AND rollID = 3;
GO
~~START~~
int#!#text
1#!#StudentA, StudentB, StudentC
2#!#StudentD, StudentE, StudentG
~~END~~

~~ROW COUNT: 1~~


DELETE FROM string_agg_order_school
WHERE classID = 1 AND rollID = 2;
GO
~~START~~
int#!#text
1#!#StudentA, StudentC
2#!#StudentD, StudentE, StudentG
~~END~~

~~ROW COUNT: 1~~

