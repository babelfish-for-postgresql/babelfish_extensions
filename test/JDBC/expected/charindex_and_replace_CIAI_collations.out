
-- tsql
/* CHARINDEX WITH CI_AI COLLATIONS */
CREATE TABLE #BABEL_4850_TEMP(id NVARCHAR(100))
GO
CREATE TABLE BABEL_4850_T(id NVARCHAR(100))
GO

INSERT INTO #BABEL_4850_TEMP VALUES ('AAAAAE'), ('AeAAAaE'), ('AeAAAaE'), ('AAAAAABBBBBBBEEEEEEAAAAA')
INSERT INTO BABEL_4850_T VALUES ('AAAAAE'), ('AeAAAaE'), ('AeAAAaE'), ('AAAAAABBBBBBBEEEEEEAAAAA')
GO
~~ROW COUNT: 4~~

~~ROW COUNT: 4~~



/* CI_AS */
/* Cases where single character is equal to two characters */
SELECT CHARINDEX('Ã†','AAAAAE' COLLATE Latin1_General_CI_AI)
SELECT CHARINDEX('Ã†','AeAAAaE' COLLATE Latin1_General_CI_AI, 2)
SELECT CHARINDEX('Ã†','AeAAAaE' COLLATE Latin1_General_CI_AI, 1)
SELECT CHARINDEX('Ã†', 'AAAAAABBBBBBBEEEEEEAAAAA' COLLATE Latin1_General_CI_AI);
SELECT CHARINDEX('Ã†A','AeAEAAAAaE' COLLATE Latin1_General_CI_AI, 1)
GO
~~START~~
int
5
~~END~~

~~START~~
int
6
~~END~~

~~START~~
int
1
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
1
~~END~~


SELECT CHARINDEX('Ã†', id COLLATE Latin1_General_CI_AI) FROM #BABEL_4850_TEMP
GO
~~START~~
int
5
1
1
0
~~END~~

SELECT CHARINDEX('Ã†', id COLLATE Latin1_General_CI_AI) FROM BABEL_4850_T
GO
~~START~~
int
5
1
1
0
~~END~~


/* BASIC TEST CASES */
/* These should find a result */
SELECT CHARINDEX('cat', 'The cat is on the mat' COLLATE Latin1_General_CI_AI, 1);
SELECT CHARINDEX('cafe', 'The CafÃ© is cozy' COLLATE Latin1_General_CI_AI, 1);
/* These should not find a result */
SELECT CHARINDEX('dog', 'The cat is on the mat' COLLATE Latin1_General_CI_AI, 1);
SELECT CHARINDEX('caÃ©', 'The cafÃ© is cozy' COLLATE Latin1_General_CI_AI, 1);
GO
~~START~~
int
5
~~END~~

~~START~~
int
5
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~


/* empty arguments */
SELECT CHARINDEX('', 'The cafÃ© is cozy' COLLATE Latin1_General_CI_AI, 1);
SELECT CHARINDEX('cafÃ©', '' COLLATE Latin1_General_CI_AI, 1);
SELECT CHARINDEX('', '' COLLATE Latin1_General_CI_AI, 1)
GO
~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~


/* case sensitivity */
SELECT CHARINDEX('tHe CaÅ¥', 'Where is The cÃ t ???' COLLATE Latin1_General_CI_AI);
SELECT CHARINDEX('caT', 'The CatÌ¤ is on the mat' COLLATE Latin1_General_CI_AI);
GO
~~START~~
int
10
~~END~~

~~START~~
int
5
~~END~~


SELECT CHARINDEX('cat', 'The cat is on the mat cAÅ¥' COLLATE Latin1_General_CI_AI, 6)
SELECT CHARINDEX('cat', 'The cat is on the mat' COLLATE Latin1_General_CI_AI, 30)
GO
~~START~~
int
23
~~END~~

~~START~~
int
0
~~END~~



/* REPLACE WITH CI_AI COLLATIONS */
/* BASIC TEST CASES */
/* These should find a result */
SELECT REPLACE('This cafÃ© is cozy.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CI_AI)
SELECT REPLACE('The cafÃ© is open for business.', 'cafÃ© is', 'coffee shops are' COLLATE Latin1_General_CI_AI)
SELECT REPLACE('This cafÃ© is cozy.', 'tea', 'coffee' COLLATE Latin1_General_CI_AI)
SELECT REPLACE('The cafÃ© serves cafÃ© au lait.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CI_AI)
GO
~~START~~
varchar
This coffee is cozy.
~~END~~

~~START~~
varchar
The coffee shops are open for business.
~~END~~

~~START~~
varchar
This cafÃ© is cozy.
~~END~~

~~START~~
varchar
The coffee serves coffee au lait.
~~END~~


SELECT REPLACE('cafÃ© is cozy.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CI_AI)
SELECT REPLACE('The cafÃ© is good.', 'is', 'was' COLLATE Latin1_General_CI_AI)
GO
~~START~~
varchar
coffee is cozy.
~~END~~

~~START~~
varchar
The cafÃ© was good.
~~END~~


SELECT REPLACE(REPLACE('The cafÃ© is open.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CI_AI), 'open', 'closed' COLLATE Latin1_General_CI_AI)
GO
~~START~~
varchar
The coffee is closed.
~~END~~


SELECT REPLACE('The cafÃ© is great.', 'gÅ™eat', N'>>>>>>' COLLATE Latin1_General_CI_AI)
SELECT REPLACE('This cafÃ© is cozy.', 'cafÃ©', N'cAfÃ«' COLLATE Latin1_General_CI_AI)
GO
~~START~~
nvarchar
The cafÃ© is >>>>>>.
~~END~~

~~START~~
nvarchar
This cAfÃ« is cozy.
~~END~~


SELECT REPLACE('This cafÃ© is cozy.', '', 'coffee' COLLATE Latin1_General_CI_AI)
SELECT REPLACE('', '', 'coffee' COLLATE Latin1_General_CI_AI)
SELECT REPLACE('This cafÃ© is cozy.', 'cafÃ©', '' COLLATE Latin1_General_CI_AI)
GO
~~START~~
varchar
This cafÃ© is cozy.
~~END~~

~~START~~
varchar

~~END~~

~~START~~
varchar
This  is cozy.
~~END~~


SELECT REPLACE('This cafÃ© is cozy.', 'CAFÃ‰', 'coffee' COLLATE Latin1_General_CI_AI)
GO
~~START~~
varchar
This coffee is cozy.
~~END~~


SELECT REPLACE('This cafÃ© is cafÃ©.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CI_AI)
GO
~~START~~
varchar
This coffee is coffee.
~~END~~


SELECT REPLACE('This cafÃ© is !.', '!', 'coffee' COLLATE Latin1_General_CI_AI)
GO
~~START~~
varchar
This cafÃ© is coffee.
~~END~~


SELECT REPLACE('This cafÃ© is cozy.', ' ', ' ' COLLATE Latin1_General_CI_AI)
SELECT REPLACE(N'The cafÃ© is!.', '!', '@@' COLLATE Latin1_General_CI_AI)
GO
~~START~~
varchar
This cafÃ© is cozy.
~~END~~

~~START~~
nvarchar
The cafÃ© is@@.
~~END~~


/* overlapping case */
SELECT REPLACE ('ABCABCABCABCABC','abcÃ€BÄ‡' collate Latin1_General_CI_AI, 'abcabc')
GO
~~START~~
varchar
abcabcabcabcABC
~~END~~


/* Cases where single character is equal to two characters */
SELECT REPLACE ('aaaaaaÃ†aaaaaaÃ†aaaa','AE' collate Latin1_General_CI_AI, '!---!')
SELECT REPLACE ('Ã†AEaaaaaaÃ†','AE' collate Latin1_General_CI_AI, '!---!')
SELECT REPLACE ('eeeeeeeeeAAAAAA','AE' collate Latin1_General_CI_AI, '!---!')
GO
~~START~~
varchar
aaaaaa!---!aaaaaa!---!aaaa
~~END~~

~~START~~
varchar
!---!!---!aaaaaa!---!
~~END~~

~~START~~
varchar
eeeeeeeeeAAAAAA
~~END~~


SELECT REPLACE(id, 'Ã†' COLLATE Latin1_General_CI_AI, '!---!') FROM #BABEL_4850_TEMP
GO
~~START~~
nvarchar
AAAA!---!
!---!AAA!---!
!---!AAA!---!
AAAAAABBBBBBBEEEEEEAAAAA
~~END~~

SELECT REPLACE(id, 'Ã†' COLLATE Latin1_General_CI_AI, '!---!') FROM BABEL_4850_T
GO
~~START~~
nvarchar
AAAA!---!
!---!AAA!---!
!---!AAA!---!
AAAAAABBBBBBBEEEEEEAAAAA
~~END~~







/* CS_AS */
/* CHARINDEX WITH CS_AI COLLATIONS */
SELECT CHARINDEX('Ã†', id COLLATE Latin1_General_CS_AI) FROM #BABEL_4850_TEMP
GO
~~START~~
int
5
0
0
0
~~END~~

SELECT CHARINDEX('Ã†', id COLLATE Latin1_General_CS_AI) FROM BABEL_4850_T
GO
~~START~~
int
5
0
0
0
~~END~~


/* Cases where single character is equal to two characters */
SELECT CHARINDEX('Ã†','AAAAAE' COLLATE Latin1_General_CS_AI)
SELECT CHARINDEX('Ã†','AeAAAaE' COLLATE Latin1_General_CS_AI, 2)
SELECT CHARINDEX('Ã†','AeAAAaE' COLLATE Latin1_General_CS_AI, 1)
SELECT CHARINDEX('Ã†', 'AAAAAABBBBBBBEEEEEEAAAAA' COLLATE Latin1_General_CS_AI);
SELECT CHARINDEX('Ã†A','AeAEAAAAaE' COLLATE Latin1_General_CS_AI, 1)
GO
~~START~~
int
5
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
3
~~END~~


/* BASIC TEST CASES */
/* These should find a result */
SELECT CHARINDEX('cat', 'The cat is on the mat' COLLATE Latin1_General_CS_AI, 1);
SELECT CHARINDEX('cafe', 'The CafÃ© is cozy' COLLATE Latin1_General_CS_AI, 1);
/* These should not find a result */
SELECT CHARINDEX('dog', 'The cat is on the mat' COLLATE Latin1_General_CS_AI, 1);
SELECT CHARINDEX('caÃ©', 'The cafÃ© is cozy' COLLATE Latin1_General_CS_AI, 1);
GO
~~START~~
int
5
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~


/* empty arguments */
SELECT CHARINDEX('', 'The cafÃ© is cozy' COLLATE Latin1_General_CS_AI, 1);
SELECT CHARINDEX('cafÃ©', '' COLLATE Latin1_General_CS_AI, 1);
SELECT CHARINDEX('', '' COLLATE Latin1_General_CS_AI, 1)
GO
~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~


/* case sensitivity */
SELECT CHARINDEX('tHe CaÅ¥', 'Where is The cÃ t ???' COLLATE Latin1_General_CS_AI);
SELECT CHARINDEX('caT', 'The CatÌ¤ is on the mat' COLLATE Latin1_General_CS_AI);
GO
~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~


SELECT CHARINDEX('cat', 'The cat is on the mat cAÅ¥' COLLATE Latin1_General_CS_AI, 6)
SELECT CHARINDEX('cat', 'The cat is on the mat' COLLATE Latin1_General_CS_AI, 30)
GO
~~START~~
int
0
~~END~~

~~START~~
int
0
~~END~~



/* REPLACE WITH CS_AI COLLATIONS */
/* BASIC TEST CASES */
/* These should find a result */
SELECT REPLACE('This cafÃ© is cozy.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CS_AI)
SELECT REPLACE('The cafÃ© is open for business.', 'cafÃ© is', 'coffee shops are' COLLATE Latin1_General_CS_AI)
SELECT REPLACE('This cafÃ© is cozy.', 'tea', 'coffee' COLLATE Latin1_General_CS_AI)
SELECT REPLACE('The cafÃ© serves cafÃ© au lait.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CS_AI)
GO
~~START~~
varchar
This coffee is cozy.
~~END~~

~~START~~
varchar
The coffee shops are open for business.
~~END~~

~~START~~
varchar
This cafÃ© is cozy.
~~END~~

~~START~~
varchar
The coffee serves coffee au lait.
~~END~~


SELECT REPLACE('cafÃ© is cozy.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CS_AI)
SELECT REPLACE('The cafÃ© is good.', 'is', 'was' COLLATE Latin1_General_CS_AI)
GO
~~START~~
varchar
coffee is cozy.
~~END~~

~~START~~
varchar
The cafÃ© was good.
~~END~~


SELECT REPLACE(REPLACE('The cafÃ© is open.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CS_AI), 'open', 'closed' COLLATE Latin1_General_CS_AI)
GO
~~START~~
varchar
The coffee is closed.
~~END~~


SELECT REPLACE('The cafÃ© is great.', 'gÅ™eat', N'>>>>>>' COLLATE Latin1_General_CS_AI)
SELECT REPLACE('This cafÃ© is cozy.', 'cafÃ©', N'cAfÃ«' COLLATE Latin1_General_CS_AI)
GO
~~START~~
nvarchar
The cafÃ© is >>>>>>.
~~END~~

~~START~~
nvarchar
This cAfÃ« is cozy.
~~END~~


SELECT REPLACE('This cafÃ© is cozy.', '', 'coffee' COLLATE Latin1_General_CS_AI)
SELECT REPLACE('', '', 'coffee' COLLATE Latin1_General_CS_AI)
SELECT REPLACE('This cafÃ© is cozy.', 'cafÃ©', '' COLLATE Latin1_General_CS_AI)
GO
~~START~~
varchar
This cafÃ© is cozy.
~~END~~

~~START~~
varchar

~~END~~

~~START~~
varchar
This  is cozy.
~~END~~


SELECT REPLACE('This cafÃ© is cozy.', 'CAFÃ‰', 'coffee' COLLATE Latin1_General_CS_AI)
GO
~~START~~
varchar
This cafÃ© is cozy.
~~END~~


SELECT REPLACE('This cafÃ© is cafÃ©.', 'cafÃ©', 'coffee' COLLATE Latin1_General_CS_AI)
GO
~~START~~
varchar
This coffee is coffee.
~~END~~


SELECT REPLACE('This cafÃ© is !.', '!', 'coffee' COLLATE Latin1_General_CS_AI)
GO
~~START~~
varchar
This cafÃ© is coffee.
~~END~~


SELECT REPLACE('This cafÃ© is cozy.', ' ', ' ' COLLATE Latin1_General_CS_AI)
SELECT REPLACE(N'The cafÃ© is!.', '!', '@@' COLLATE Latin1_General_CS_AI)
GO
~~START~~
varchar
This cafÃ© is cozy.
~~END~~

~~START~~
nvarchar
The cafÃ© is@@.
~~END~~


/* overlapping case */
SELECT REPLACE ('ABCABCABCABCABC','abcÃ€BÄ‡' collate Latin1_General_CS_AI, 'abcabc')
GO
~~START~~
varchar
ABCABCABCABCABC
~~END~~


/* Cases where single character is equal to two characters */
SELECT REPLACE ('aaaaaaÃ†aaaaaaÃ†aaaa','AE' collate Latin1_General_CS_AI, '!---!')
SELECT REPLACE ('Ã†AEaaaaaaÃ†','AE' collate Latin1_General_CS_AI, '!---!')
SELECT REPLACE ('eeeeeeeeeAAAAAA','AE' collate Latin1_General_CS_AI, '!---!')
GO
~~START~~
varchar
aaaaaa!---!aaaaaa!---!aaaa
~~END~~

~~START~~
varchar
!---!!---!aaaaaa!---!
~~END~~

~~START~~
varchar
eeeeeeeeeAAAAAA
~~END~~


SELECT REPLACE(id, 'Ã†' COLLATE Latin1_General_CS_AI, '!---!') FROM #BABEL_4850_TEMP
GO
~~START~~
nvarchar
AAAA!---!
AeAAAaE
AeAAAaE
AAAAAABBBBBBBEEEEEEAAAAA
~~END~~

SELECT REPLACE(id, 'Ã†' COLLATE Latin1_General_CS_AI, '!---!') FROM BABEL_4850_T
GO
~~START~~
nvarchar
AAAA!---!
AeAAAaE
AeAAAaE
AAAAAABBBBBBBEEEEEEAAAAA
~~END~~


DROP TABLE BABEL_4850_T
GO

/* Substring to find starts with surrogate pair BABEL-5169 */
SELECT CHARINDEX(N'ðŸ™‚dEf', N'abcðŸ™‚defðŸ™‚defghðŸ™‚dEfiðŸ™‚ðŸ™‚' COLLATE Latin1_General_CS_AI)
SELECT CHARINDEX(N'ðŸ™‚D', N'abcðŸ™‚dðŸ™‚dðŸ™‚D' COLLATE Latin1_General_CS_AI)
SELECT CHARINDEX(N'ðŸ™‚dEf', N'abcðŸ™‚defghðŸ™‚dEfiðŸ™‚ðŸ™‚' COLLATE Latin1_General_CI_AI)
SELECT CHARINDEX(N'ðŸ™‚', N'abcðŸ™‚defghðŸ™‚dEfiðŸ™‚ðŸ™‚' COLLATE Latin1_General_CS_AI)
SELECT CHARINDEX(N'ðŸ™‚', N'abcðŸ™‚defghðŸ™‚dEfiðŸ™‚ðŸ™‚' COLLATE Latin1_General_CI_AI)
GO
~~START~~
int
14
~~END~~

~~START~~
int
8
~~END~~

~~START~~
int
4
~~END~~

~~START~~
int
4
~~END~~

~~START~~
int
4
~~END~~


/* Substring to find starts with surrogate pair BABEL-5169 */
SELECT REPLACE(N'abcðŸ™‚defghiðŸ™‚ðŸ™‚', N'ðŸ™‚def', N'jhiðŸ™‚' COLLATE Latin1_General_CI_AI)
SELECT REPLACE(N'abcðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚defghiðŸ™‚ðŸ™‚', N'ðŸ™‚', N'<---->' COLLATE Latin1_General_CI_AI)
SELECT REPLACE(N'abcðŸ™‚ðŸ™‚ðŸ™‚ðŸ™‚', N'ðŸ™‚', N'<---->' COLLATE Latin1_General_CI_AI)
SELECT REPLACE(N'ðŸ™‚abcðŸ™‚', N'ðŸ™‚', N'<---->' COLLATE Latin1_General_CI_AI)
GO
~~START~~
nvarchar
abcjhiðŸ™‚ghiðŸ™‚ðŸ™‚
~~END~~

~~START~~
nvarchar
abc<----><----><----><----><---->defghi<----><---->
~~END~~

~~START~~
nvarchar
abc<----><----><----><---->
~~END~~

~~START~~
nvarchar
<---->abc<---->
~~END~~


-- psql
CREATE COLLATION case_insensitive (provider = icu, locale = 'und-u-ks-level2', deterministic = false);
CREATE COLLATION ignore_accents (provider = icu, locale = 'nd-u-kc-true-ks-level1', deterministic = false);
GO

CREATE TABLE mismatch_col (col1 text COLLATE case_insensitive, col2 text COLLATE ignore_accents, col3 text);
GO

INSERT INTO mismatch_col VALUES ('abc', 'xyz', 'tde');
GO
~~ROW COUNT: 1~~


SELECT REPLACE(col1, col2, col3) FROM mismatch_col
GO
~~ERROR (Code: 0)~~

~~ERROR (Message: ERROR: could not determine which collation to use for string comparison
  Hint: Use the COLLATE clause to set the collation explicitly.
    Server SQLState: 42P22)~~


DROP TABLE mismatch_col
GO

DROP COLLATION case_insensitive;
DROP COLLATION ignore_accents;
GO
