-- tsql
create table test_tbl_trig_bbf_1(a int);
create table test_tbl_trig_bbf_2(a int);
GO

-- psql
create table master_dbo.psql_tbl_1(a int unique);
create table master_dbo.psql_tbl_2(a int);
GO

-- psql
grant all on master_dbo.psql_tbl_1 to public;
GO

-- psql
CREATE OR REPLACE FUNCTION master_dbo.f_trig_pg_1() RETURNS trigger
AS $$
BEGIN
        insert into master_dbo.psql_tbl_1 values (1);
        RETURN NEW;
END;
$$ LANGUAGE plpgsql;
GO

-- psql
CREATE OR REPLACE FUNCTION master_dbo.f_trig_pg_2() RETURNS trigger
AS $$
BEGIN
        insert into master_dbo.psql_tbl_2 values (1);
        RETURN NEW;
END;
$$ LANGUAGE plpgsql;
GO

-- psql
CREATE TRIGGER pg_trigger_1 AFTER INSERT OR DELETE OR UPDATE ON master_dbo.test_tbl_trig_bbf_1 
    FOR EACH ROW EXECUTE FUNCTION master_dbo.f_trig_pg_1();
GO

-- psql
CREATE TRIGGER pg_trigger_2 AFTER INSERT OR DELETE OR UPDATE ON master_dbo.test_tbl_trig_bbf_2 
    FOR EACH ROW EXECUTE FUNCTION master_dbo.f_trig_pg_2();
GO

-- tsql
begin tran;
GO

insert into test_tbl_trig_bbf_1 values (1);
GO
~~ROW COUNT: 1~~


select @@trancount;
GO
~~START~~
int
1
~~END~~


commit tran;
GO

select count(*) from test_tbl_trig_bbf_1;
GO
~~START~~
int
1
~~END~~


select count(*) from psql_tbl_1;
GO
~~START~~
int
1
~~END~~


begin tran;
GO

-- should throw permission denied error
insert into test_tbl_trig_bbf_2 values (1);
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: permission denied for table psql_tbl_2)~~


select @@trancount
GO
~~START~~
int
1
~~END~~


rollback tran;
GO

select count(*) from test_tbl_trig_bbf_2;
GO
~~START~~
int
0
~~END~~


begin tran;
GO

-- should throw duplicte entry error
insert into test_tbl_trig_bbf_1 values (1);
GO
~~ERROR (Code: 2627)~~

~~ERROR (Message: duplicate key value violates unique constraint "psql_tbl_1_a_key")~~


select @@trancount;
GO
~~START~~
int
1
~~END~~


rollback tran;
GO

select count(*) from test_tbl_trig_bbf_1;
GO
~~START~~
int
1
~~END~~


select count(*) from psql_tbl_1;
GO
~~START~~
int
1
~~END~~



-- psql
drop function master_dbo.f_trig_pg_1() cascade;
drop function master_dbo.f_trig_pg_2() cascade;
GO
~~WARNING (Code: 0)~~

~~WARNING (Message: drop cascades to trigger pg_trigger_1 on table master_dbo.test_tbl_trig_bbf_1  Server SQLState: 00000)~~~~WARNING (Message: drop cascades to trigger pg_trigger_2 on table master_dbo.test_tbl_trig_bbf_2  Server SQLState: 00000)~~

~~WARNING (Code: 0)~~

~~WARNING (Message: drop cascades to trigger pg_trigger_1 on table master_dbo.test_tbl_trig_bbf_1  Server SQLState: 00000)~~~~WARNING (Message: drop cascades to trigger pg_trigger_2 on table master_dbo.test_tbl_trig_bbf_2  Server SQLState: 00000)~~


drop table master_dbo.psql_tbl_1;
drop table master_dbo.psql_tbl_2;
GO

-- tsql
drop table test_tbl_trig_bbf_1;
drop table test_tbl_trig_bbf_2;
GO
