-- tsql
CREATE TABLE babelfish_migration_mode_table (id_num INT IDENTITY(1,1), mig_mode VARCHAR(10))
GO
INSERT INTO babelfish_migration_mode_table SELECT current_setting('babelfishpg_tsql.migration_mode')
GO
~~ROW COUNT: 1~~


-- test multi-db mode
SELECT set_config('role', 'jdbc_user', false);
GO
~~START~~
text
jdbc_user
~~END~~

SELECT set_config('babelfishpg_tsql.migration_mode', 'multi-db', false);
GO
~~START~~
text
multi-db
~~END~~


-- tsql
CREATE TABLE test_babel_4279_t1([ABC.nfds] INT, [DEf.j] INT);
GO

CREATE VIEW test_babel_4279_v1 AS SELECT test_babel_4279_t1.[ABC.nfds] from test_babel_4279_t1;
GO

CREATE VIEW test_babel_4279_v2 AS SELECT [test_babel_4279_t1].[ABC.nfds] ,test_babel_4279_t1.[DEf.j] from test_babel_4279_t1;
GO

CREATE DATABASE ["test_babel_4279_d.1"];
GO

USE ["test_babel_4279_d.1"];
GO

CREATE SCHEMA test_babel_4279_s1;
GO

CREATE TABLE test_babel_4279_s1.test_babel_4279_st1([ABC.nfds] INT, [DEf.j] INT);
GO

CREATE VIEW test_babel_4279_sv1 AS SELECT [test_babel_4279_s1].[test_babel_4279_st1].[ABC.nfds] from test_babel_4279_s1.test_babel_4279_st1;
GO

USE MASTER
GO

CREATE VIEW test_babel_4279_v3 AS SELECT ["test_babel_4279_d.1"].[test_babel_4279_s1].[test_babel_4279_st1].[ABC.nfds] from ["test_babel_4279_d.1"].[test_babel_4279_s1].[test_babel_4279_st1];
GO

CREATE TABLE test_babel_4279_t2(您您对您对您对您对您对您对您对您对您对您您您 INT, 对您对您对您对您对您对您对您 INT);
GO

CREATE VIEW test_babel_4279_v4 AS SELECT test_babel_4279_t2.[您您对您对您对您对您对您对您对您对您对您您您] from test_babel_4279_t2;
GO

CREATE VIEW test_babel_4279_v5 AS SELECT ぁあ.[您您对您对您对您对您对您对您对您对您对您您您] from test_babel_4279_t2 AS ぁあ;
GO

CREATE SCHEMA "tngdf'";
GO

CREATE TABLE "tngdf'".[sc,sdg"fdsngjds']("AB[C" INT);
GO

CREATE VIEW test_babel_4279_v6 AS SELECT "tngdf'".[sc,sdg"fdsngjds']."AB[C" from "tngdf'".[sc,sdg"fdsngjds'];
GO

CREATE TABLE test_babel_4279_t3(ABCD INT);
GO

CREATE VIEW test_babel_4279_v7 AS SELECT  test_babel_4279_t3.ABCD FROM test_babel_4279_t3;
GO

CREATE TABLE test_babel_4279_t4([ぁあ'"] INT);
GO

CREATE VIEW test_babel_4279_v8 AS SELECT test_babel_4279_t4.[ぁあ'"] FROM test_babel_4279_t4;
GO

-- psql
SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_v1';
GO
~~START~~
text
 SELECT "abc.nfds" AS "ABC.nfds"<newline>   FROM master_dbo.test_babel_4279_t1;
~~END~~


SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_v2';
GO
~~START~~
text
 SELECT "abc.nfds" AS "ABC.nfds",<newline>    "def.j" AS "DEf.j"<newline>   FROM master_dbo.test_babel_4279_t1;
~~END~~


SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_sv1';
GO
~~START~~
text
 SELECT "abc.nfds" AS "ABC.nfds"<newline>   FROM """test_babel_4279_d.1""_test_babel_4279_s1".test_babel_4279_st1;
~~END~~


SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_v3';
GO
~~START~~
text
 SELECT "abc.nfds" AS "ABC.nfds"<newline>   FROM """test_babel_4279_d.1""_test_babel_4279_s1".test_babel_4279_st1;
~~END~~


SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_v4';
GO
~~START~~
text
 SELECT "您您对您对您对您对您d60211ff7d947ff09db87babbf0cb9de"<newline>   FROM master_dbo.test_babel_4279_t2;
~~END~~


SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_v5';
GO
~~START~~
text
 SELECT "您您对您对您对您对您d60211ff7d947ff09db87babbf0cb9de"<newline>   FROM master_dbo.test_babel_4279_t2 "ぁあ";
~~END~~


SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_v6';
GO
~~START~~
text
 SELECT "ab[c" AS "AB[C"<newline>   FROM "master_tngdf'"."sc,sdg""fdsngjds'";
~~END~~


SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_v7';
GO
~~START~~
text
 SELECT abcd AS "ABCD"<newline>   FROM master_dbo.test_babel_4279_t3;
~~END~~


SELECT pg_catalog.pg_get_viewdef(oid, true) FROM pg_class WHERE relname = 'test_babel_4279_v8';
GO
~~START~~
text
 SELECT "ぁあ'"""<newline>   FROM master_dbo.test_babel_4279_t4;
~~END~~


-- tsql
DROP VIEW test_babel_4279_v1;
GO

DROP VIEW test_babel_4279_v2;
GO

DROP VIEW test_babel_4279_v3;
GO

DROP TABLE test_babel_4279_t1;
GO

USE ["test_babel_4279_d.1"];
GO

DROP VIEW test_babel_4279_sv1;
GO

DROP TABLE test_babel_4279_s1.test_babel_4279_st1;
GO

DROP SCHEMA test_babel_4279_s1;
GO

USE MASTER;
GO

DROP DATABASE ["test_babel_4279_d.1"];
GO

DROP VIEW test_babel_4279_v4;
GO

DROP VIEW test_babel_4279_v5;
GO

DROP TABLE test_babel_4279_t2;
GO

DROP VIEW test_babel_4279_v6;
GO

DROP TABLE "tngdf'".[sc,sdg"fdsngjds'];
GO

DROP SCHEMA "tngdf'";
GO

DROP VIEW test_babel_4279_v7;
GO

DROP TABLE test_babel_4279_t3;
GO

DROP VIEW test_babel_4279_v8;
GO

DROP TABLE test_babel_4279_t4;
GO

CREATE TABLE t2(c int)
GO

CREATE TABLE t1(c int)
GO

-- should not crash when column followed by '\n'|'\t' etc.
CREATE VIEW v
AS
SELECT t1.c
FROM	dbo.t2 INNER JOIN t1  
ON t2.c = t1.c
GO

DROP VIEW v
GO

DROP TABLE t2
GO

DROP TABLE t1
GO

CREATE TABLE t3(RecordEntryId bigint NOT NULL)	
GO

CREATE FUNCTION tvf_t3(@UserId BIGINT)
RETURNS TABLE
AS
RETURN 
(
select	rp.RecordEntryId
from	dbo.t3 rp
)
GO

DROP FUNCTION tvf_t3
GO

DROP TABLE t3
GO

SELECT set_config('role', 'jdbc_user', false);
GO
~~START~~
text
jdbc_user
~~END~~


-- Reset migration mode to default
DECLARE @mig_mode VARCHAR(10)
SET @mig_mode = (SELECT mig_mode FROM babelfish_migration_mode_table WHERE id_num = 1)
SELECT CASE WHEN (SELECT set_config('babelfishpg_tsql.migration_mode', @mig_mode, false)) IS NOT NULL THEN 1 ELSE 0 END
GO
~~START~~
int
1
~~END~~


Drop Table IF EXISTS babelfish_migration_mode_table
GO
