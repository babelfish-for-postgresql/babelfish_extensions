CREATE TABLE babel_4585_t1(a VARCHAR(10));
GO
INSERT INTO babel_4585_t1 values('2000-12-12');
INSERT INTO babel_4585_t1 values('1000-01-01');
GO
~~ROW COUNT: 1~~

~~ROW COUNT: 1~~


CREATE TABLE babel_4585_t2(id INT);
GO

# JIRA
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
FETCH NEXT FROM date_cursor
FETCH NEXT FROM date_cursor
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~START~~
int
-24
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~

~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~


# Cursor should default to type NO SCROLL
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
FETCH PRIOR FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: cursor can only scan forward)~~



# declare cur -> open cur -> insert stmt 
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
INSERT INTO babel_4585_t2 VALUES (1);
FETCH NEXT FROM date_cursor
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~ROW COUNT: 1~~

~~START~~
int
-24
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~


SELECT COUNT(*) FROM babel_4585_t2
DELETE FROM babel_4585_t2
GO
~~START~~
int
1
~~END~~

~~ROW COUNT: 1~~


# declare cur -> open cur -> insert stmt -> fetch error -> close and reopen cur
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
INSERT INTO babel_4585_t2 VALUES (1);
FETCH NEXT FROM date_cursor
FETCH NEXT FROM date_cursor
CLOSE date_cursor
OPEN date_cursor
FETCH NEXT FROM date_cursor
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~ROW COUNT: 1~~

~~START~~
int
-24
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~

~~START~~
int
-24
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~


SELECT COUNT(*) FROM babel_4585_t2
DELETE FROM babel_4585_t2
GO
~~START~~
int
1
~~END~~

~~ROW COUNT: 1~~


# declare cur -> open cur -> begin tran -> insert stmt -> commit -> fetch next
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
SELECT @@trancount, ' ==> trancount'
BEGIN TRAN
INSERT INTO babel_4585_t2 VALUES (1);
SELECT @@trancount, ' ==> trancount'
FETCH NEXT FROM date_cursor
COMMIT
SELECT @@trancount, ' ==> trancount'
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~START~~
int#!#varchar
0#!# ==> trancount
~~END~~

~~ROW COUNT: 1~~

~~START~~
int#!#varchar
1#!# ==> trancount
~~END~~

~~START~~
int
-24
~~END~~

~~START~~
int#!#varchar
0#!# ==> trancount
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~


SELECT COUNT(*) FROM babel_4585_t2
DELETE FROM babel_4585_t2
GO
~~START~~
int
1
~~END~~

~~ROW COUNT: 1~~


# begin tran -> declare cur -> open cur -> insert stmt -> fetch -> fetch -> commit
BEGIN TRAN
GO
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
INSERT INTO babel_4585_t2 VALUES (1);
SELECT @@trancount, ' ==> trancount'
FETCH NEXT FROM date_cursor
FETCH NEXT FROM date_cursor
COMMIT
SELECT @@trancount, ' ==> trancount'
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~ROW COUNT: 1~~

~~START~~
int#!#varchar
1#!# ==> trancount
~~END~~

~~START~~
int
-24
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~

~~START~~
int#!#varchar
0#!# ==> trancount
~~END~~

~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~


SELECT COUNT(*) FROM babel_4585_t2
DELETE FROM babel_4585_t2
GO
~~START~~
int
1
~~END~~

~~ROW COUNT: 1~~



# Use table which will be dropped through rollback -> open cursor after table dropped should throw error
BEGIN TRAN
GO
CREATE TABLE babel_4585_t3(a VARCHAR(10));
GO
INSERT INTO babel_4585_t3 values('2000-12-12');
INSERT INTO babel_4585_t3 values('1000-01-01');
GO
~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t3
OPEN date_cursor
INSERT INTO babel_4585_t2 VALUES (1);
SELECT @@trancount, ' ==> trancount'
ROLLBACK
FETCH NEXT FROM date_cursor
FETCH NEXT FROM date_cursor
SELECT @@trancount, ' ==> trancount'
FETCH NEXT FROM date_cursor
CLOSE date_cursor
OPEN date_cursor
FETCH NEXT FROM date_cursor
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~ROW COUNT: 1~~

~~START~~
int#!#varchar
1#!# ==> trancount
~~END~~

~~START~~
int
-24
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~

~~START~~
int#!#varchar
0#!# ==> trancount
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~

~~ERROR (Code: 33557097)~~

~~ERROR (Message: relation "babel_4585_t3" does not exist)~~


SELECT COUNT(*) FROM babel_4585_t2
DELETE FROM babel_4585_t2
GO
~~START~~
int
0
~~END~~


# begin tran -> begin tran -> declare cur -> open cur -> commit -> fetch  -> commit -> fetch
BEGIN TRAN
GO
BEGIN TRAN
GO
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
INSERT INTO babel_4585_t2 VALUES (1);
SELECT @@trancount, ' ==> trancount'
COMMIT
INSERT INTO babel_4585_t2 VALUES (2);
FETCH NEXT FROM date_cursor
COMMIT
INSERT INTO babel_4585_t2 VALUES (3);
FETCH NEXT FROM date_cursor
SELECT @@trancount, ' ==> trancount'
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~ROW COUNT: 1~~

~~START~~
int#!#varchar
2#!# ==> trancount
~~END~~

~~ROW COUNT: 1~~

~~START~~
int
-24
~~END~~

~~ROW COUNT: 1~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~

~~START~~
int#!#varchar
0#!# ==> trancount
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~


SELECT COUNT(*) FROM babel_4585_t2
DELETE FROM babel_4585_t2
GO
~~START~~
int
3
~~END~~

~~ROW COUNT: 3~~


# begin tran -> save tran -> declare cur -> open cur -> insert stmt -> rollback to -> fetch -> commit -> fetch
BEGIN TRAN
GO
SAVE TRAN sp1
GO
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
INSERT INTO babel_4585_t2 VALUES (1);
SELECT @@trancount, ' ==> trancount'
ROLLBACK TRAN sp1
INSERT INTO babel_4585_t2 VALUES (2);
FETCH NEXT FROM date_cursor
COMMIT
INSERT INTO babel_4585_t2 VALUES (3);
FETCH NEXT FROM date_cursor
SELECT @@trancount, ' ==> trancount'
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~ROW COUNT: 1~~

~~START~~
int#!#varchar
1#!# ==> trancount
~~END~~

~~ROW COUNT: 1~~

~~START~~
int
-24
~~END~~

~~ROW COUNT: 1~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~

~~START~~
int#!#varchar
0#!# ==> trancount
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~


SELECT COUNT(*) FROM babel_4585_t2
DELETE FROM babel_4585_t2
GO
~~START~~
int
2
~~END~~

~~ROW COUNT: 2~~


# begin tran -> declare cur -> open cur -> save tran -> insert stmt -> rollback to -> fetch -> commit -> fetch
BEGIN TRAN
GO
DECLARE date_cursor CURSOR FOR SELECT DATEDIFF(Year, GetDate(), a) FROM babel_4585_t1
OPEN date_cursor
SAVE TRAN sp1
INSERT INTO babel_4585_t2 VALUES (1);
SELECT @@trancount, ' ==> trancount'
ROLLBACK TRAN sp1
INSERT INTO babel_4585_t2 VALUES (2);
FETCH NEXT FROM date_cursor
COMMIT
INSERT INTO babel_4585_t2 VALUES (3);
FETCH NEXT FROM date_cursor
SELECT @@trancount, ' ==> trancount'
FETCH NEXT FROM date_cursor
CLOSE date_cursor
DEALLOCATE date_cursor
GO
~~ROW COUNT: 1~~

~~START~~
int#!#varchar
1#!# ==> trancount
~~END~~

~~ROW COUNT: 1~~

~~START~~
int
-24
~~END~~

~~ROW COUNT: 1~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~

~~START~~
int#!#varchar
0#!# ==> trancount
~~END~~

~~START~~
int
~~ERROR (Code: 517)~~

~~ERROR (Message: data out of range for datetime)~~


SELECT COUNT(*) FROM babel_4585_t2
DELETE FROM babel_4585_t2
GO
~~START~~
int
2
~~END~~

~~ROW COUNT: 2~~



DROP TABLE IF EXISTS babel_4585_t1, babel_4585_t2, babel_4585_t2
GO
