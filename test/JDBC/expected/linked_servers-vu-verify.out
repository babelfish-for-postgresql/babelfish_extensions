-- Check if the linked server added is reflected in the system view
SELECT name, product, provider, data_source, provider_string, catalog, is_linked FROM sys.servers ORDER BY name
GO
~~START~~
varchar#!#varchar#!#varchar#!#nvarchar#!#nvarchar#!#varchar#!#bit
hello.world.com#!##!#tds_fdw#!#hello.world.com#!#<NULL>#!#<NULL>#!#1
mssql_server#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server1#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server2#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server3#!##!#tds_fdw#!#mssql_server2\ABC#!#<NULL>#!#master#!#1
~~END~~


SELECT * FROM sys_linked_servers_vu_prepare__sys_servers_func()
GO
~~START~~
varchar#!#varchar#!#varchar#!#nvarchar#!#nvarchar#!#varchar#!#bit
hello.world.com#!##!#tds_fdw#!#hello.world.com#!#<NULL>#!#<NULL>#!#1
mssql_server#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server1#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server2#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server3#!##!#tds_fdw#!#mssql_server2\ABC#!#<NULL>#!#master#!#1
~~END~~


SELECT * FROM sys_linked_servers_vu_prepare__sys_servers_view
GO
~~START~~
varchar#!#varchar#!#varchar#!#nvarchar#!#nvarchar#!#varchar#!#bit
hello.world.com#!##!#tds_fdw#!#hello.world.com#!#<NULL>#!#<NULL>#!#1
mssql_server#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server1#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server2#!##!#tds_fdw#!#localhost#!#<NULL>#!#master#!#1
mssql_server3#!##!#tds_fdw#!#mssql_server2\ABC#!#<NULL>#!#master#!#1
~~END~~


SELECT s.name as linked_srv_name, l.remote_name as username FROM sys.servers as s INNER JOIN sys.linked_logins as l on s.server_id = l.server_id ORDER BY linked_srv_name
GO
~~START~~
varchar#!#varchar
mssql_server#!#jdbc_user
mssql_server2#!#only_user_no_password
mssql_server3#!#<NULL>
~~END~~


SELECT * FROM sys_linked_servers_vu_prepare__sys_linked_logins_view
GO
~~START~~
varchar#!#varchar
mssql_server#!#jdbc_user
mssql_server2#!#only_user_no_password
mssql_server3#!#<NULL>
~~END~~


-- Trying to drop a server that does not exist (Should throw error)
EXEC sp_dropserver @server = 'mssql_server_that_does_not_exist', @droplogins = NULL
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: server "mssql_server_that_does_not_exist" does not exist)~~


-- Trying to drop a server with @droplogins = invalid value (Should throw error)
EXEC sp_dropserver @server = 'mssql_server', @droplogins = 'definitely_invalid'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Invalid parameter value for @droplogins specified in procedure 'sys.sp_dropserver', acceptable values are 'droplogins' or NULL.)~~


-- Dropping a server without droplogins should also drop the server and the linked login
EXEC sp_dropserver @server = 'mssql_server', @droplogins = NULL
GO

SELECT * FROM sys.servers WHERE name = 'mssql_server'
GO
~~START~~
int#!#varchar#!#varchar#!#varchar#!#nvarchar#!#nvarchar#!#nvarchar#!#varchar#!#int#!#int#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#varchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#datetime#!#bit
~~END~~


SELECT s.name as linked_srv_name, l.remote_name as username FROM sys.servers as s INNER JOIN sys.linked_logins as l on s.server_id = l.server_id WHERE s.name = 'mssql_server'
GO
~~START~~
varchar#!#varchar
~~END~~


-- Dropping a server with droplogins should drop the linked logins as well. Also call sp_dropserver from master.dbo schema
EXEC master.dbo.sp_dropserver @server = 'mssql_server2', @droplogins = 'droplogins'
GO

SELECT * FROM sys.servers WHERE name = 'mssql_server'
GO
~~START~~
int#!#varchar#!#varchar#!#varchar#!#nvarchar#!#nvarchar#!#nvarchar#!#varchar#!#int#!#int#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#varchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#datetime#!#bit
~~END~~


SELECT s.name as linked_srv_name, l.remote_name as username FROM sys.servers as s INNER JOIN sys.linked_logins as l on s.server_id = l.server_id WHERE s.name = 'mssql_server2'
GO
~~START~~
varchar#!#varchar
~~END~~

