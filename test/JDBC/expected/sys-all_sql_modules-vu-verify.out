-- Test for function
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys_all_sql_modules_vu_function')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
CREATE OR REPLACE FUNCTION master_dbo.sys_all_sql_modules_vu_function()<newline> RETURNS integer<newline> LANGUAGE pltsql<newline>AS '{"version_num": "1", "typmod_array": ["-1"], "original_probin": ""}', $function$BEGIN<newline>    RETURN 1;<newline>END$function$<newline>#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for views
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys_all_sql_modules_vu_view')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
CREATE VIEW sys_all_sql_modules_vu_view AS<newline>SELECT 1 as c#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for triggers
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = (SELECT TOP(1) object_id FROM sys.all_objects WHERE name = 'sys_all_sql_modules_vu_trig')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for proc
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys_all_sql_modules_vu_proc')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
CREATE OR REPLACE PROCEDURE master_dbo.sys_all_sql_modules_vu_proc()<newline> LANGUAGE pltsql<newline>AS '{"version_num": "1", "typmod_array": [], "original_probin": ""}', $procedure$SELECT 1 as c$procedure$<newline>#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for system function
SELECT
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys.fn_listextendedproperty')
GO
~~START~~
bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for system views
SELECT
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys.tables')
GO
~~START~~
bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test for system proc
SELECT
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys.sp_tables')
GO
~~START~~
bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


-- Test that sys.all_sql_modules is database-scoped
SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys_all_sql_modules_vu_my_db_view')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
~~END~~


-- Test permission for all_sql_modules (query should not have any results)
CREATE LOGIN sys_all_sql_modules_vu_user WITH PASSWORD='test'
GO

CREATE USER sys_all_sql_modules_vu_user FOR LOGIN sys_all_sql_modules_vu_user
GO

USE master
GO

-- tsql user=sys_all_sql_modules_vu_user password=test

SELECT
    definition,
    uses_ansi_nulls,
    uses_quoted_identifier,
    is_schema_bound,
    uses_database_collation,
    is_recompiled,
    null_on_null_input,
    execute_as_principal_id,
    uses_native_compilation
FROM sys.all_sql_modules
WHERE object_id = OBJECT_ID('sys_all_sql_modules_vu_proc')
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
~~END~~


-- psql

-- Need to terminate active session before cleaning up the login
SELECT pg_terminate_backend(pid) FROM pg_stat_get_activity(NULL) 
WHERE sys.suser_name(usesysid) = 'sys_all_sql_modules_vu_user' AND backend_type = 'client backend' AND usesysid IS NOT NULL;
GO
~~START~~
bool
t
~~END~~

-- Wait to sync with another session
SELECT pg_sleep(1);
GO
~~START~~
void

~~END~~


-- tsql
DROP LOGIN sys_all_sql_modules_vu_user
GO

DROP USER sys_all_sql_modules_vu_user
GO


-- dependent objects for upgrade
SELECT * FROM sys_all_sql_modules_vu_dep_view
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
CREATE VIEW sys_all_sql_modules_vu_view AS<newline>SELECT 1 as c#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


EXEC sys_all_sql_modules_vu_dep_proc
GO
~~START~~
nvarchar#!#bit#!#bit#!#bit#!#bit#!#bit#!#bit#!#int#!#bit
CREATE VIEW sys_all_sql_modules_vu_view AS<newline>SELECT 1 as c#!#1#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#0
~~END~~


SELECT sys_all_sql_modules_vu_dep_func()
GO
~~START~~
int
1
~~END~~

