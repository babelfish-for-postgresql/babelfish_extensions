-- tsql
CREATE LOGIN ownership_restrictions_from_pg_login1 WITH password = '123';
GO

CREATE LOGIN ownership_restrictions_from_pg_login2 WITH password = '12345678';
GO

-- tsql user=ownership_restrictions_from_pg_login2 password=12345678
CREATE ROLE ownership_restrictions_from_pg_role_by_pg_login2;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: User does not have permission to perform this action.)~~


CREATE USER ownership_restrictions_from_pg_user_by_pg_login2;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: User does not have permission to perform this action.)~~


-- tsql
ALTER SERVER ROLE sysadmin ADD MEMBER ownership_restrictions_from_pg_login2;
GO

-- tsql user=ownership_restrictions_from_pg_login2 password=12345678
CREATE DATABASE ownership_restrictions_from_pg_login2_db1;
GO

-- tsql
ALTER SERVER ROLE sysadmin DROP MEMBER ownership_restrictions_from_pg_login2;
GO

-- tsql user=ownership_restrictions_from_pg_login2 password=12345678
USE ownership_restrictions_from_pg_login2_db1;
GO

SELECT current_user;
GO
~~START~~
varchar
dbo
~~END~~


CREATE ROLE ownership_restrictions_from_pg_role_by_pg_login2;
GO

DROP ROLE ownership_restrictions_from_pg_role_by_pg_login2;
GO

-- This is a temporary failure, it will be fixed with BABEL-4652.
CREATE USER ownership_restrictions_from_pg_user_by_pg_login2;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: errstart was not called)~~



-- DROP USER ownership_restrictions_from_pg_user_by_pg_login2;
-- GO
USE master;
go

-- tsql
DROP DATABASE ownership_restrictions_from_pg_login2_db1;
go

CREATE ROLE ownership_restrictions_from_pg_role1;
go

-- psql
CREATE USER ownership_restrictions_from_pg_test_user WITH PASSWORD '12345678' inherit;
go

-- psql user=ownership_restrictions_from_pg_test_user password=12345678
DROP ROLE master_ownership_restrictions_from_pg_role1;
GO
~~ERROR (Code: 0)~~

~~ERROR (Message: ERROR: Babelfish-created users/roles cannot be dropped or altered outside of a Babelfish session
    Server SQLState: 42501)~~


-- psql
-- Dropping login from psql port should fail
DROP ROLE ownership_restrictions_from_pg_login1;
GO
~~ERROR (Code: 0)~~

~~ERROR (Message: ERROR: Babelfish-created login cannot be dropped or altered outside of a Babelfish session
    Server SQLState: 55006)~~


SELECT pg_terminate_backend(pid) FROM pg_stat_get_activity(NULL)
WHERE sys.suser_name(usesysid) = 'ownership_restrictions_from_pg_login2' AND backend_type = 'client backend' AND usesysid IS NOT NULL;
GO
~~START~~
bool
t
~~END~~


-- Create a non babelfish role that is a member of master_guest
-- and enable dropping
CREATE ROLE ownership_restrictions_from_pg_role2 IN ROLE master_guest, tempdb_guest, msdb_guest;
GO

DROP ROLE ownership_restrictions_from_pg_role2;
GO
~~ERROR (Code: 0)~~

~~ERROR (Message: ERROR: Babelfish-created login cannot be dropped or altered outside of a Babelfish session
    Server SQLState: 55006)~~


SET enable_drop_babelfish_role = true;
GO

DROP ROLE ownership_restrictions_from_pg_role2;
GO

SET enable_drop_babelfish_role = false;
GO


CREATE ROLE ownership_restrictions_from_pg_role3;
GO

GRANT master_guest TO ownership_restrictions_from_pg_role3;
GRANT tempdb_guest TO ownership_restrictions_from_pg_role3;
GRANT msdb_guest TO ownership_restrictions_from_pg_role3;
GO

DROP ROLE ownership_restrictions_from_pg_role3;
GO
~~ERROR (Code: 0)~~

~~ERROR (Message: ERROR: Babelfish-created login cannot be dropped or altered outside of a Babelfish session
    Server SQLState: 55006)~~


SET enable_drop_babelfish_role = true;
GO

DROP ROLE ownership_restrictions_from_pg_role3;
GO

SET enable_drop_babelfish_role = false;
GO

-- Test a regular role
CREATE ROLE ownership_restrictions_from_pg_role4;
GO

DROP ROLE ownership_restrictions_from_pg_role4;
GO

DROP USER ownership_restrictions_from_pg_test_user;
GO

-- tsql
DROP ROLE ownership_restrictions_from_pg_role1;
GO

DROP LOGIN ownership_restrictions_from_pg_login1;
GO

DROP LOGIN ownership_restrictions_from_pg_login2;
GO
