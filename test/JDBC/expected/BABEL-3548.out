-- tsql
create login test_login1 with password='123';
go

alter server role sysadmin add member test_login1;
go

-- tsql      user=test_login1      password=123
create database login1_db;
go

-- tsql
alter server role sysadmin drop member test_login1;
go

-- tsql      user=test_login1      password=123
-- Shouldn't cause error as login is the db owner
use login1_db;
go

select CURRENT_USER;
go
~~START~~
varchar
dbo
~~END~~


use master;
go

select CURRENT_USER;
go
~~START~~
varchar
guest
~~END~~


drop database login1_db;
go

-- tsql
create database sysadmin_only_db;
go

-- tsql      user=test_login1      password=123
-- Should fail
use sysadmin_only_db;
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: The server principal "test_login1" is not able to access the database "sysadmin_only_db" under the current security context)~~


use master;
go

-- Should fail
drop database sysadmin_only_db;
go
~~ERROR (Code: 33557097)~~

~~ERROR (Message: must be owner of database sysadmin_only_db)~~


-- psql
-- Need to terminate active session before cleaning up the login
SELECT pg_terminate_backend(pid) FROM pg_stat_get_activity(NULL) 
WHERE sys.suser_name(usesysid) = 'test_login1' AND backend_type = 'client backend' AND usesysid IS NOT NULL;
GO
~~START~~
bool
t
~~END~~

-- Wait to sync with another session
SELECT pg_sleep(1);
GO
~~START~~
void

~~END~~


-- tsql
drop database sysadmin_only_db;
drop login test_login1;
go

