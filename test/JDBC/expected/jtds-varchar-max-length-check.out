
-- pre-test cleanup
drop table if exists jtds_varchar_max_tab1
go
drop table if exists jtds_varchar_max_data_tab
go

-- test data
create table jtds_varchar_max_data_tab (id int, st varchar(max))
go
insert into jtds_varchar_max_data_tab values (1, 'lj3wqE3KGfAxmLgfCgwNpKqZViapgUUjrSxzoebtvyVCWYew9Y3yJ8GEzhpjoMmX')
insert into jtds_varchar_max_data_tab values (2, '4uyJp45fjKxHhANMZzr1dqgcQmMJNT2Mbyp1v06WvKWX3fpJyzYAKNZOY3lkJ1z6')
insert into jtds_varchar_max_data_tab values (3, 'tQCrp7KnW8QxWM9BjsR8XEHiwM8PA2i8XBPJMcHi9p0bYBIQNGar3bvAdvgGKzbB')
insert into jtds_varchar_max_data_tab values (4, 'wLrui6MHI0nNTjNE1duq6ceULP8DwvCaBnq5CsWMfD2tiUS47PuV3BGvMPxkw2t7')
insert into jtds_varchar_max_data_tab values (5, 'AALdAoIE7hiPPNCLsGGC7sdPoB39SZfJ0xrxodKjKDgG1XsWXsO9Q8a3yUnjmhUc')
insert into jtds_varchar_max_data_tab values (6, 'RacLS9WFUaxfzKVIaVxUjOqBTGct3TC2J3huk58ocl899X851HhVJA4RbPyS4LZS')
insert into jtds_varchar_max_data_tab values (7, 'rlGrVDPsmtNM4OH1p5c4FOhUVz1cQet91wIZAvjOupVtVDPbDEOmhvtnL2Lo1ndY')
insert into jtds_varchar_max_data_tab values (8, '4PxSBAM1hG4RCJiFDqKhzrlADzK4ejk5e6kwsu81Y8PzWLJ1czlrEXaGdEdSq0Z7')
go
~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~


-- table to insert string of increasing length into
create table jtds_varchar_max_tab1 (exp_count int, col1 varchar(max))
go

-- empty and short strings
insert into jtds_varchar_max_tab1 values (-1, null)
go
~~ROW COUNT: 1~~

insert into jtds_varchar_max_tab1 values (0, '')
go
~~ROW COUNT: 1~~

insert into jtds_varchar_max_tab1 values (16,
    substring((select top 1 st from jtds_varchar_max_data_tab order by id), 1, 16))
go
~~ROW COUNT: 1~~


-- long strings
insert into jtds_varchar_max_tab1 values (8192,
    (select concat(a, a, a, a, a, a, a, a, a, a, a, a, a, a, a, a) from
        (select string_agg(st, '') as a from (select top 8 st from jtds_varchar_max_data_tab order by id))))
go
~~ROW COUNT: 1~~

insert into jtds_varchar_max_tab1 values (32768,
    (select concat(b, b, b, b) from
        (select concat(a, a, a, a, a, a, a, a, a, a, a, a, a, a, a, a) as b from
            (select string_agg(st, '') as a from (select top 8 st from jtds_varchar_max_data_tab order by id)))))
go
~~ROW COUNT: 1~~

insert into jtds_varchar_max_tab1 values (65536,
    (select concat(b, b, b, b, b, b, b, b) from
        (select concat(a, a, a, a, a, a, a, a, a, a, a, a, a, a, a, a) as b from
            (select string_agg(st, '') as a from (select top 8 st from jtds_varchar_max_data_tab order by id)))))
go
~~ROW COUNT: 1~~

insert into jtds_varchar_max_tab1 values (131072,
    (select concat(b, b, b, b, b, b, b, b, b, b, b, b, b, b, b, b) from
        (select concat(a, a, a, a, a, a, a, a, a, a, a, a, a, a, a, a) as b from
            (select string_agg(st, '') as a from (select top 8 st from jtds_varchar_max_data_tab order by id)))))
go
~~ROW COUNT: 1~~


-- check inserted length
select exp_count, length(col1) from jtds_varchar_max_tab1 order by exp_count
go
~~START~~
int#!#int
-1#!#<NULL>
0#!#0
16#!#16
8192#!#8192
32768#!#32768
65536#!#65536
131072#!#131072
~~END~~


-- check inserted contents
select col1 from jtds_varchar_max_tab1 where exp_count = 8192
go
~~START~~
varchar
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
~~END~~




-- data is returned, but cannot be read by JTDS
-- see test runner log file for error details
--select col1 from jtds_varchar_max_tab1 where exp_count = 32768
--go
-- error message is returned by server instead of data
--select col1 from jtds_varchar_max_tab1 where exp_count = 131072
--go
-- cleanup
drop table jtds_varchar_max_tab1
go
drop table jtds_varchar_max_data_tab
go
