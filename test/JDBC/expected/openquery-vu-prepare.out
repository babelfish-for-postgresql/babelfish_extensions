-- psql
CREATE EXTENSION IF NOT EXISTS tds_fdw;
GO

-- tsql
-- Add localhost as linked server
EXEC sp_addlinkedserver  @server = N'bbf_server', @srvproduct=N'', @provider=N'SQLNCLI', @datasrc=N'localhost', @catalog=N'master'
GO

-- Add jdbc_user as linked server login
EXEC sp_addlinkedsrvlogin @rmtsrvname = 'bbf_server', @useself = 'FALSE', @rmtuser = 'jdbc_user', @rmtpassword = '12345678'
GO

-- Add a linked server that cannot be connected to
EXEC sp_addlinkedserver  @server = N'bbf_server_unreachable', @srvproduct=N'', @provider=N'SQLNCLI', @datasrc=N'blahblahblah', @catalog=N'master'
GO

-- Add dummy as linked server login for this server
EXEC sp_addlinkedsrvlogin @rmtsrvname = 'bbf_server_unreachable', @useself = 'FALSE', @rmtuser = 'dummy_usr', @rmtpassword = 'dummy_pwd'
GO

-- Test sp_serveroption procedure
EXEC sp_addlinkedserver  @server = N'bbf_server_1', @srvproduct=N'', @provider=N'SQLNCLI', @datasrc=N'localhost', @catalog=N'master'
GO

-- Add jdbc_user as linked server login
EXEC sp_addlinkedsrvlogin @rmtsrvname = 'bbf_server_1', @useself = 'FALSE', @rmtuser = 'jdbc_user', @rmtpassword = '12345678'
GO

-- sp_serveroption with invalid server name. Should throw error
EXEC sp_serveroption @server='invalid_server', @optname='query timeout', @optvalue='1'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: server "invalid_server" does not exist)~~


-- sp_serveroption with invalid server option. Should throw error
EXEC sp_serveroption @server='bbf_server_1', @optname='invalid option', @optvalue='1'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Invalid option provided for sp_serveroption)~~


-- sp_serveroption with server as NULL. Should throw error
EXEC sp_serveroption @server=NULL, @optname='query timeout', @optvalue='1'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: @server parameter cannot be NULL)~~


-- sp_serveroption with optname as NULL. Should throw error
EXEC sp_serveroption @server='bbf_server_1', @optname=NULL, @optvalue='1'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: @optname parameter cannot be NULL)~~


-- sp_serveroption with optvalue as NULL. Should throw error
EXEC sp_serveroption @server='bbf_server_1', @optname='query timeout', @optvalue=NULL
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: @optvalue parameter cannot be NULL)~~


-- sp_serveroption with negative optvalue
EXEC sp_serveroption @server='bbf_server_1', @optname='query timeout', @optvalue='-5'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Invalid option value for query timeout)~~


-- sp_serveroption with float optvalue. should throw error
EXEC sp_serveroption @server='bbf_server_1', @optname='query timeout', @optvalue='1.0001'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Invalid option value for query timeout)~~


-- sp_serveroption with optvalue greater than INT_MAX. should throw error
EXEC sp_serveroption @server='bbf_server_1', @optname='query timeout', @optvalue='2147483648'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Query timeout value provided is out of range)~~


-- sp_serveroption with optvalue containing characters other than 0-9. should throw error
EXEC sp_serveroption @server='bbf_server_1', @optname='query timeout', @optvalue='0abdejc'
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: Invalid option value for query timeout)~~


-- sp_serveroption with optvalue = INT_MAX
EXEC sp_serveroption @server='bbf_server_1', @optname='query timeout', @optvalue='2147483647'
GO

-- sp_serveroption with optvalue containing leading zeroes
EXEC sp_serveroption @server='bbf_server_1', @optname='query timeout', @optvalue='0000002'
GO

-- check the value of query timeout from sys.servers
select name, query_timeout from sys.servers where name = 'bbf_server_1'
GO
~~START~~
varchar#!#int
bbf_server_1#!#2
~~END~~


-- sp_serveroption with valid server, optname and optvalue
EXEC sp_serveroption @server='bbf_server_1', @optname='query timeout', @optvalue='5'
GO

-- optname is case insensitive
EXEC sp_serveroption @server='bbf_server_1', @optname='queRY tiMEoUt', @optvalue='1'
GO

-- psql
SELECT * FROM sys.babelfish_inconsistent_metadata();
GO
~~START~~
varchar#!#varchar#!#varchar#!#jsonb
~~END~~


-- Output passed rules
SELECT * FROM sys.babelfish_inconsistent_metadata(true);
GO
~~START~~
varchar#!#varchar#!#varchar#!#jsonb
text#!#sys#!#name#!#{"Rule": "master must exist in babelfish_sysdatabases"}
text#!#sys#!#name#!#{"Rule": "tempdb must exist in babelfish_sysdatabases"}
text#!#sys#!#name#!#{"Rule": "msdb must exist in babelfish_sysdatabases"}
name#!#sys#!#rolname#!#{"Rule": "Current role name must exist in babelfish_authid_login_ext"}
name#!#sys#!#nspname#!#{"Rule": "master_dbo must exist in babelfish_namespace_ext"}
name#!#sys#!#nspname#!#{"Rule": "tempdb_dbo must exist in babelfish_namespace_ext"}
name#!#sys#!#nspname#!#{"Rule": "msdb_dbo must exist in babelfish_namespace_ext"}
name#!#sys#!#rolname#!#{"Rule": "master_db_owner must exist in babelfish_authid_user_ext"}
name#!#sys#!#rolname#!#{"Rule": "master_dbo must exist in babelfish_authid_user_ext"}
name#!#sys#!#rolname#!#{"Rule": "tempdb_db_owner must exist in babelfish_authid_user_ext"}
name#!#sys#!#rolname#!#{"Rule": "tempdb_dbo must exist in babelfish_authid_user_ext"}
name#!#sys#!#rolname#!#{"Rule": "msdb_db_owner must exist in babelfish_authid_user_ext"}
name#!#sys#!#rolname#!#{"Rule": "msdb_dbo must exist in babelfish_authid_user_ext"}
name#!#sys#!#rolname#!#{"Rule": "<owner> in babelfish_sysdatabases must also exist in babelfish_authid_login_ext"}
name#!#sys#!#rolname#!#{"Rule": "<owner> in babelfish_sysdatabases must also exist in babelfish_authid_login_ext"}
name#!#sys#!#rolname#!#{"Rule": "<owner> in babelfish_sysdatabases must also exist in babelfish_authid_login_ext"}
name#!#pg_catalog#!#nspname#!#{"Rule": "<nspname> in babelfish_namespace_ext must also exist in pg_namespace"}
name#!#pg_catalog#!#nspname#!#{"Rule": "<nspname> in babelfish_namespace_ext must also exist in pg_namespace"}
name#!#pg_catalog#!#nspname#!#{"Rule": "<nspname> in babelfish_namespace_ext must also exist in pg_namespace"}
name#!#pg_catalog#!#nspname#!#{"Rule": "<nspname> in babelfish_namespace_ext must also exist in pg_namespace"}
name#!#pg_catalog#!#nspname#!#{"Rule": "<nspname> in babelfish_namespace_ext must also exist in pg_namespace"}
name#!#pg_catalog#!#nspname#!#{"Rule": "<nspname> in babelfish_namespace_ext must also exist in pg_namespace"}
name#!#pg_catalog#!#nspname#!#{"Rule": "<nspname> in babelfish_namespace_ext must also exist in pg_namespace"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_login_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<default_database_name> in babelfish_authid_login_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_login_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<default_database_name> in babelfish_authid_login_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#pg_catalog#!#rolname#!#{"Rule": "<rolname> in babelfish_authid_user_ext must also exist in pg_authid"}
text#!#sys#!#name#!#{"Rule": "<database_name> in babelfish_authid_user_ext must also exist in babelfish_sysdatabases"}
name#!#sys#!#nspname#!#{"Rule": "<nspname> in babelfish_function_ext must also exist in babelfish_namespace_ext"}
name#!#pg_catalog#!#proname#!#{"Rule": "<funcname> in babelfish_function_ext must also exist in pg_proc"}
name#!#sys#!#nspname#!#{"Rule": "<nspname> in babelfish_function_ext must also exist in babelfish_namespace_ext"}
name#!#pg_catalog#!#proname#!#{"Rule": "<funcname> in babelfish_function_ext must also exist in pg_proc"}
name#!#pg_catalog#!#srvname#!#{"Rule": "<servername> in babelfish_server_options must also exist in pg_foreign_server"}
name#!#pg_catalog#!#srvname#!#{"Rule": "<servername> in babelfish_server_options must also exist in pg_foreign_server"}
name#!#pg_catalog#!#srvname#!#{"Rule": "<servername> in babelfish_server_options must also exist in pg_foreign_server"}
~~END~~


-- tsql
-- check if the linked servers are dropped above are reflected in babelfish_server_options catalog
SELECT servername, query_timeout FROM babelfish_server_options WHERE servername = 'bbf_server' OR servername = 'bbf_server_1'
GO
~~START~~
varchar#!#int
bbf_server#!#0
bbf_server_1#!#1
~~END~~


-- Create a view dependent on OPENQUERY
CREATE VIEW openquery_vu_prepare__openquery_view AS SELECT * FROM OPENQUERY(bbf_server, 'SELECT 1')
GO
