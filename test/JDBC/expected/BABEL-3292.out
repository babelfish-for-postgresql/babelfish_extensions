drop table if exists babel_3292_t1
go

create table babel_3292_t1(a1 int PRIMARY KEY, b1 int)
go

create index index_babel_3292_t1_b1 on babel_3292_t1(b1)
go

create table babel_3292_t2(a2 int PRIMARY KEY, b2 int)
go
~~ERROR (Code: 2714)~~

~~ERROR (Message: relation "babel_3292_t2" already exists)~~


create index index_babel_3292_t2_b2 on babel_3292_t2(b2)
go
~~ERROR (Code: 2714)~~

~~ERROR (Message: relation "index_babel_3292_t2_b2babel_3297b13d7f53f3b499d8db9cc07605bd434" already exists)~~


set babelfish_showplan_all on
go

/*
 * Run a SELECT query without any hints to ensure that un-hinted queries still work.
 * This also ensures that when the SELECT query is not hinted it produces a different plan(bitmap heap scan and bitmap index scan)
 * than the index scan that we're hinting in the query below. This verifies that the next test is actually valid.
 * If the planner was going to choose a sequential scan anyway, the next test wouldn't actually prove that hints were working.
 */
select * from babel_3292_t1 where b1 = 1
go
~~START~~
text
Query Text: select * from babel_3292_t1 where b1 = 1
Bitmap Heap Scan on babel_3292_t1  (cost=4.24..14.91 rows=11 width=8)
  Recheck Cond: (b1 = 1)
  ->  Bitmap Index Scan on index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736  (cost=0.00..4.24 rows=11 width=0)
        Index Cond: (b1 = 1)
~~END~~


/*
 * Run SELECT queries and give the hint to follow a index scan using different syntaxes.
 * The query plan should now use a idex scan instead of the bitmap heap and bitmap index scan it uses in the un-hinted test above.
 */
select * from babel_3292_t1 (index(index_babel_3292_t1_b1)) where b1 = 1
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3292_t1 index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736) */ select * from babel_3292_t1                                 where b1 = 1
Index Scan using index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736 on babel_3292_t1  (cost=0.15..36.35 rows=11 width=8)
  Index Cond: (b1 = 1)
~~END~~


select * from babel_3292_t1 (index=index_babel_3292_t1_b1) where b1 = 1
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3292_t1 index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736) */ select * from babel_3292_t1                                where b1 = 1
Index Scan using index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736 on babel_3292_t1  (cost=0.15..36.35 rows=11 width=8)
  Index Cond: (b1 = 1)
~~END~~


select * from babel_3292_t1 with(index(index_babel_3292_t1_b1)) where b1 = 1
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3292_t1 index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736) */ select * from babel_3292_t1                                     where b1 = 1
Index Scan using index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736 on babel_3292_t1  (cost=0.15..36.35 rows=11 width=8)
  Index Cond: (b1 = 1)
~~END~~


select * from babel_3292_t1 with(index=index_babel_3292_t1_b1) where b1 = 1
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3292_t1 index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736) */ select * from babel_3292_t1                                    where b1 = 1
Index Scan using index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736 on babel_3292_t1  (cost=0.15..36.35 rows=11 width=8)
  Index Cond: (b1 = 1)
~~END~~



/*
 * Test with multiple index hints
 */
select * from babel_3292_t1, babel_3292_t2 where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: select * from babel_3292_t1, babel_3292_t2 where b1 = 1 and b2 = 1
Nested Loop  (cost=8.48..31.36 rows=121 width=16)
  ->  Bitmap Heap Scan on babel_3292_t1  (cost=4.24..14.91 rows=11 width=8)
        Recheck Cond: (b1 = 1)
        ->  Bitmap Index Scan on index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736  (cost=0.00..4.24 rows=11 width=0)
              Index Cond: (b1 = 1)
  ->  Materialize  (cost=4.24..14.97 rows=11 width=8)
        ->  Bitmap Heap Scan on babel_3292_t2  (cost=4.24..14.91 rows=11 width=8)
              Recheck Cond: (b2 = 1)
              ->  Bitmap Index Scan on index_babel_3292_t2_b2babel_3297b13d7f53f3b499d8db9cc07605bd434  (cost=0.00..4.24 rows=11 width=0)
                    Index Cond: (b2 = 1)
~~END~~


select * from babel_3292_t1 with(index(index_babel_3292_t1_b1)), babel_3292_t2 with(index(index_babel_3292_t2_b2)) where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3292_t1 index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736) IndexScan(babel_3292_t2 index_babel_3292_t2_b2babel_3297b13d7f53f3b499d8db9cc07605bd434) */ select * from babel_3292_t1                                    , babel_3292_t2                                     where b1 = 1 and b2 = 1
Nested Loop  (cost=0.31..74.23 rows=121 width=16)
  ->  Index Scan using index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736 on babel_3292_t1  (cost=0.15..36.35 rows=11 width=8)
        Index Cond: (b1 = 1)
  ->  Materialize  (cost=0.15..36.40 rows=11 width=8)
        ->  Index Scan using index_babel_3292_t2_b2babel_3297b13d7f53f3b499d8db9cc07605bd434 on babel_3292_t2  (cost=0.15..36.35 rows=11 width=8)
              Index Cond: (b2 = 1)
~~END~~


select * from babel_3292_t1 with(index=index_babel_3292_t1_b1), babel_3292_t2 with(index=index_babel_3292_t2_b2) where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3292_t1 index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736) IndexScan(babel_3292_t2 index_babel_3292_t2_b2babel_3297b13d7f53f3b499d8db9cc07605bd434) */ select * from babel_3292_t1                                   , babel_3292_t2                                    where b1 = 1 and b2 = 1
Nested Loop  (cost=0.31..74.23 rows=121 width=16)
  ->  Index Scan using index_babel_3292_t1_b1babel_329eaeb7a8893929b580f3d762dc8499736 on babel_3292_t1  (cost=0.15..36.35 rows=11 width=8)
        Index Cond: (b1 = 1)
  ->  Materialize  (cost=0.15..36.40 rows=11 width=8)
        ->  Index Scan using index_babel_3292_t2_b2babel_3297b13d7f53f3b499d8db9cc07605bd434 on babel_3292_t2  (cost=0.15..36.35 rows=11 width=8)
              Index Cond: (b2 = 1)
~~END~~


set babelfish_showplan_all off
go

-- cleanup
drop table babel_3292_t1
go

drop table babel_3292_t2
go
