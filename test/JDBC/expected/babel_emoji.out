-- Test SYS.NCHAR, SYS.NVARCHAR and SYS.VARCHAR
-- nchar is already available in postgres dialect
select CAST('Â£' AS nchar(1));
GO
~~START~~
nchar
Â£
~~END~~

-- nvarchar is not available in postgres dialect
select CAST('Â£' AS nvarchar);
GO
~~START~~
nvarchar
Â£
~~END~~


-- both are available in tsql dialect
DECLARE @babelfishpg_tsql_sql_dialect varchar(50) = 'tsql';
GO
select CAST('Â£' AS nchar(2));
GO
~~START~~
nchar
Â£ 
~~END~~

select CAST('Â£' AS nvarchar(2));
GO
~~START~~
nvarchar
Â£
~~END~~


-- multi-byte character doesn't fit in nchar(1) in tsql if it
-- would require a UTF16-surrogate-pair on output
select CAST('Â£' AS char(1));			-- allowed
GO
~~START~~
char
Â£
~~END~~

select CAST('Â£' AS sys.nchar(1));		-- allowed
GO
~~START~~
nchar
Â£
~~END~~

select CAST('Â£' AS sys.nvarchar(1));	-- allowed
GO
~~START~~
nvarchar
Â£
~~END~~

select CAST('Â£' AS sys.varchar(1));		-- allowed
GO
~~START~~
varchar
Â£
~~END~~


select CAST('ðŸ˜€' AS char(1));			-- not allowed  TODO: fix BABEL-3543
GO
~~START~~
char
?
~~END~~

select CAST('ðŸ˜€' AS sys.nchar(1));		-- not allowed
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character(1) as UTF16 output)~~

select CAST('ðŸ˜€' AS sys.nvarchar(1));	-- not allowed
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character varying(1) as UTF16 output)~~

select CAST('ðŸ˜€' AS sys.varchar(1));	-- not allowed  TODO: fix BABEL-3543 
GO
~~START~~
varchar
?
~~END~~


-- Check that things work the same in postgres dialect
select CAST('Â£' AS char(1));
GO
~~START~~
char
Â£
~~END~~

select CAST('Â£' AS sys.nchar(1));
GO
~~START~~
nchar
Â£
~~END~~

select CAST('Â£' AS sys.nvarchar(1));
GO
~~START~~
nvarchar
Â£
~~END~~

select CAST('Â£' AS sys.varchar(1));
GO
~~START~~
varchar
Â£
~~END~~

select CAST('ðŸ˜€' AS char(1));
GO
~~START~~
char
?
~~END~~

select CAST('ðŸ˜€' AS sys.nchar(1)); -- this should not be allowed as nchar is T-SQL type
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character(1) as UTF16 output)~~

select CAST('ðŸ˜€' AS sys.nvarchar(1)); -- this should not be allowed as nvarchar is T-SQL type
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character varying(1) as UTF16 output)~~

select CAST('ðŸ˜€' AS sys.varchar(1)); -- this should not be allowed as sys.varchar is T-SQL type  TODO: fix BABEL-3543 
GO
~~START~~
varchar
?
~~END~~

DECLARE @babelfishpg_tsql_sql_dialect varchar(50) = 'tsql';
GO

-- test normal create domain works when apg_enable_domain_typmod is enabled
-- set apg_enable_domain_typmod true;
create TYPE varchar3 FROM varchar(3);
select CAST('abÂ£' AS varchar3);
GO
~~START~~
varchar
abÂ£
~~END~~

select CAST('abðŸ˜€' AS varchar3); --not allowed  TODO: fix BABEL-3543 
GO
~~START~~
varchar
ab?
~~END~~


-- don't allow surrogate pairs to exceed max length
select CAST('ðŸ˜€b' AS char(1));  -- not allowed TODO: fix BABEL-3543 
GO
~~START~~
char
?
~~END~~

select CAST('ðŸ˜€b' AS nchar(1));
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character(1) as UTF16 output)~~

select CAST('ðŸ˜€b' AS nvarchar(1));
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character varying(1) as UTF16 output)~~

select CAST('ðŸ˜€b' AS sys.varchar(1)); -- not allowed TODO: fix BABEL-3543 
GO
~~START~~
varchar
?
~~END~~


-- default length of nchar/char is 1 in tsql (and pg)
create table testing1(col nchar);
GO

SELECT * FROM information_schema.columns WHERE table_name = 'testing1'
GO
~~START~~
nvarchar#!#nvarchar#!#nvarchar#!#nvarchar#!#int#!#nvarchar#!#varchar#!#nvarchar#!#int#!#int#!#tinyint#!#smallint#!#int#!#smallint#!#nvarchar#!#nvarchar#!#nvarchar#!#nvarchar#!#nvarchar#!#nvarchar#!#nvarchar#!#nvarchar#!#nvarchar
master#!#dbo#!#testing1#!#col#!#1#!#<NULL>#!#YES#!#nchar#!#1#!#2#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#bbf_unicode_cp1_ci_as#!#<NULL>#!#<NULL>#!#<NULL>
~~END~~


-- check length at insert
insert into testing1 (col) select 'ðŸ˜€';  -- not allowed TODO: fix BABEL-3543 
select * from testing1;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character(1) as UTF16 output)~~


-- default length of nvarchar in tsql is 1
create table testing2(col nvarchar);
insert into testing2 (col) select 'ðŸ˜€'; -- not allowed TODO: fix BABEL-3543 
select * from testing2;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character varying(1) as UTF16 output)~~


-- default length of varchar in tsql is 1
create table testing4(col sys.varchar);
insert into testing4 (col) select 'ðŸ˜€'; -- not allowed TODO: fix BABEL-3543 
GO
~~ROW COUNT: 1~~

-- space is automatically truncated
insert into testing2 (col) select 'Â£ ';
GO
~~ROW COUNT: 1~~

insert into testing2 (col) select 'ðŸ¤“ '; -- not allowed TODO: fix BABEL-3543 
select * from testing4;
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: value too long for type character varying(1) as UTF16 output)~~



drop table testing1;
GO
drop table testing2;
GO
drop table testing4;
GO
