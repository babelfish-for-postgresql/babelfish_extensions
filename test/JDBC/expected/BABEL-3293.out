drop table if exists babel_3293_t1
go

drop table if exists babel_3293_t2
go

create table babel_3293_t1(a1 int PRIMARY KEY, b1 int)
go

create index index_babel_3293_t1_b1 on babel_3293_t1(b1)
go

create table babel_3293_t2(a2 int PRIMARY KEY, b2 int)
go

create index index_babel_3293_t2_b2 on babel_3293_t2(b2)
go

select set_config('babelfishpg_tsql.explain_costs', 'off', false)
go
~~START~~
text
off
~~END~~


set babelfish_showplan_all on
go

/*
 * Run a SELECT query joining two tables without any join hints to ensure that un-hinted queries still work.
 * This also ensures that when the SELECT query is not hinted it produces a different plan(hash join)
 * than the other join plans that we're hinting in the queries below. This verifies that the next set of tests are actually valid.
 */
select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
Hash Join
  Hash Cond: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Bitmap Heap Scan on babel_3293_t1
        Recheck Cond: (b1 = 1)
        ->  Bitmap Index Scan on index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210
              Index Cond: (b1 = 1)
  ->  Hash
        ->  Bitmap Heap Scan on babel_3293_t2
              Recheck Cond: (b2 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e
                    Index Cond: (b2 = 1)
~~END~~


/*
 * Give the hints in the queries to follow a specified join plan.
 * The query plan should now use the specified join plan instead of hash join it uses in the un-hinted test above.
 */
select * from babel_3293_t1 inner merge join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: /*+ MergeJoin(babel_3293_t1 babel_3293_t2) */ select * from babel_3293_t1 inner       join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
Merge Join
  Merge Cond: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Sort
        Sort Key: babel_3293_t1.a1
        ->  Bitmap Heap Scan on babel_3293_t1
              Recheck Cond: (b1 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210
                    Index Cond: (b1 = 1)
  ->  Sort
        Sort Key: babel_3293_t2.a2
        ->  Bitmap Heap Scan on babel_3293_t2
              Recheck Cond: (b2 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e
                    Index Cond: (b2 = 1)
~~END~~


select * from babel_3293_t1 left outer loop join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: /*+ NestLoop(babel_3293_t1 babel_3293_t2) */ select * from babel_3293_t1 left outer      join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
Nested Loop
  Join Filter: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Bitmap Heap Scan on babel_3293_t1
        Recheck Cond: (b1 = 1)
        ->  Bitmap Index Scan on index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210
              Index Cond: (b1 = 1)
  ->  Materialize
        ->  Bitmap Heap Scan on babel_3293_t2
              Recheck Cond: (b2 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e
                    Index Cond: (b2 = 1)
~~END~~


select * from babel_3293_t1 with(index(index_babel_3293_t1_b1)) join babel_3293_t2 (index(index_babel_3293_t2_b2)) on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1 -- Join query with just table hints
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3293_t1 index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210) IndexScan(babel_3293_t2 index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e) */ select * from babel_3293_t1                                     join babel_3293_t2                                 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
Hash Join
  Hash Cond: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Index Scan using index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210 on babel_3293_t1
        Index Cond: (b1 = 1)
  ->  Hash
        ->  Index Scan using index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e on babel_3293_t2
              Index Cond: (b2 = 1)
~~END~~


-- Join hints through option clause
select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1 option(hash join)
go
~~START~~
text
Query Text: /*+ Set(enable_mergejoin off) Set(enable_nestloop off) */ select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1                  
Hash Join
  Hash Cond: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Bitmap Heap Scan on babel_3293_t1
        Recheck Cond: (b1 = 1)
        ->  Bitmap Index Scan on index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210
              Index Cond: (b1 = 1)
  ->  Hash
        ->  Bitmap Heap Scan on babel_3293_t2
              Recheck Cond: (b2 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e
                    Index Cond: (b2 = 1)
~~END~~


select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1 option(merge join)
go
~~START~~
text
Query Text: /*+ Set(enable_hashjoin off) Set(enable_nestloop off) */ select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1                   
Merge Join
  Merge Cond: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Sort
        Sort Key: babel_3293_t1.a1
        ->  Bitmap Heap Scan on babel_3293_t1
              Recheck Cond: (b1 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210
                    Index Cond: (b1 = 1)
  ->  Sort
        Sort Key: babel_3293_t2.a2
        ->  Bitmap Heap Scan on babel_3293_t2
              Recheck Cond: (b2 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e
                    Index Cond: (b2 = 1)
~~END~~


select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1 option(loop join)
go
~~START~~
text
Query Text: /*+ Set(enable_hashjoin off) Set(enable_mergejoin off) */ select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1                  
Nested Loop
  Join Filter: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Bitmap Heap Scan on babel_3293_t1
        Recheck Cond: (b1 = 1)
        ->  Bitmap Index Scan on index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210
              Index Cond: (b1 = 1)
  ->  Materialize
        ->  Bitmap Heap Scan on babel_3293_t2
              Recheck Cond: (b2 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e
                    Index Cond: (b2 = 1)
~~END~~


-- Queries with both table hints and join hints
select * from babel_3293_t1 with(index(index_babel_3293_t1_b1)) inner loop join babel_3293_t2 (index(index_babel_3293_t2_b2)) on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3293_t1 index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210) IndexScan(babel_3293_t2 index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e) NestLoop(babel_3293_t1 babel_3293_t2) */ select * from babel_3293_t1                                     inner      join babel_3293_t2                                 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
Nested Loop
  Join Filter: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Index Scan using index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210 on babel_3293_t1
        Index Cond: (b1 = 1)
  ->  Materialize
        ->  Index Scan using index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e on babel_3293_t2
              Index Cond: (b2 = 1)
~~END~~


select * from babel_3293_t1 with(index(index_babel_3293_t1_b1)) right outer merge join babel_3293_t2 (index(index_babel_3293_t2_b2)) on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: /*+ IndexScan(babel_3293_t1 index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210) IndexScan(babel_3293_t2 index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e) MergeJoin(babel_3293_t1 babel_3293_t2) */ select * from babel_3293_t1                                     right outer       join babel_3293_t2                                 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1
Merge Join
  Merge Cond: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Sort
        Sort Key: babel_3293_t1.a1
        ->  Index Scan using index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210 on babel_3293_t1
              Index Cond: (b1 = 1)
  ->  Sort
        Sort Key: babel_3293_t2.a2
        ->  Index Scan using index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e on babel_3293_t2
              Index Cond: (b2 = 1)
~~END~~


select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1 option(loop join, table hint(babel_3293_t1, index(index_babel_3293_t1_b1)), table hint(babel_3293_t2, index(index_babel_3293_t2_b2)))
go
~~START~~
text
Query Text: /*+ Set(enable_hashjoin off) Set(enable_mergejoin off) IndexScan(babel_3293_t1 index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210) IndexScan(babel_3293_t2 index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e) */ select * from babel_3293_t1 join babel_3293_t2 on babel_3293_t1.a1 = babel_3293_t2.a2 where b1 = 1 and b2 = 1                                                                                                                                      
Nested Loop
  Join Filter: (babel_3293_t1.a1 = babel_3293_t2.a2)
  ->  Index Scan using index_babel_3293_t1_b1babel_329dabb714f0f2c475b9c9e7d1d90cbd210 on babel_3293_t1
        Index Cond: (b1 = 1)
  ->  Materialize
        ->  Index Scan using index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e on babel_3293_t2
              Index Cond: (b2 = 1)
~~END~~


set babelfish_showplan_all off
go

-- cleanup
drop table babel_3293_t1
go

drop table babel_3293_t2
go


-- Test all queries by specifying a database and schema name
use tempdb
go

drop table if exists babel_3293_schema.t1
go

drop table if exists babel_3293_t2
go

drop schema if exists babel_3293_schema
go

create schema babel_3293_schema
go

create table babel_3293_schema.t1(a1 int PRIMARY KEY, b1 int)
go

create index index_babel_3293_schema_t1_b1 on babel_3293_schema.t1(b1)
go

create table babel_3293_t2(a2 int PRIMARY KEY, b2 int)
go

create index index_babel_3293_t2_b2 on babel_3293_t2(b2)
go

select set_config('babelfishpg_tsql.explain_costs', 'off', false)
go
~~START~~
text
off
~~END~~


set babelfish_showplan_all on
go

select * from tempdb.babel_3293_schema.t1 inner merge join tempdb.dbo.babel_3293_t2 on tempdb.babel_3293_schema.t1.a1 = tempdb.dbo.babel_3293_t2.a2 where b1 = 1 and b2 = 1
go
~~START~~
text
Query Text: /*+ MergeJoin(t1 babel_3293_t2) */ select * from tempdb.babel_3293_schema.t1 inner       join tempdb.dbo.babel_3293_t2 on tempdb.babel_3293_schema.t1.a1 = tempdb.dbo.babel_3293_t2.a2 where b1 = 1 and b2 = 1
Merge Join
  Merge Cond: (t1.a1 = babel_3293_t2.a2)
  ->  Sort
        Sort Key: t1.a1
        ->  Bitmap Heap Scan on t1
              Recheck Cond: (b1 = 1)
              ->  Bitmap Index Scan on index_babel_3293_schema_t1_b1t1baa4a261b22c51c48cc060f8d390c3e9
                    Index Cond: (b1 = 1)
  ->  Sort
        Sort Key: babel_3293_t2.a2
        ->  Bitmap Heap Scan on babel_3293_t2
              Recheck Cond: (b2 = 1)
              ->  Bitmap Index Scan on index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e
                    Index Cond: (b2 = 1)
~~END~~


select * from tempdb.babel_3293_schema.t1 with(index(index_babel_3293_schema_t1_b1)) join babel_3293_t2 (index(index_babel_3293_t2_b2)) on tempdb.babel_3293_schema.t1.a1 = tempdb.dbo.babel_3293_t2.a2 where b1 = 1 and b2 = 1 -- Join query with just table hints
go
~~START~~
text
Query Text: /*+ IndexScan(t1 index_babel_3293_schema_t1_b1t1baa4a261b22c51c48cc060f8d390c3e9) IndexScan(babel_3293_t2 index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e) */ select * from tempdb.babel_3293_schema.t1                                            join babel_3293_t2                                 on tempdb.babel_3293_schema.t1.a1 = tempdb.dbo.babel_3293_t2.a2 where b1 = 1 and b2 = 1
Hash Join
  Hash Cond: (t1.a1 = babel_3293_t2.a2)
  ->  Index Scan using index_babel_3293_schema_t1_b1t1baa4a261b22c51c48cc060f8d390c3e9 on t1
        Index Cond: (b1 = 1)
  ->  Hash
        ->  Index Scan using index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e on babel_3293_t2
              Index Cond: (b2 = 1)
~~END~~


select * from tempdb.babel_3293_schema.t1 join babel_3293_t2 on tempdb.babel_3293_schema.t1.a1 = tempdb.dbo.babel_3293_t2.a2 where b1 = 1 and b2 = 1 option(merge join, table hint(tempdb.babel_3293_schema.t1, index(index_babel_3293_schema_t1_b1)), table hint(tempdb.dbo.babel_3293_t2, index(index_babel_3293_t2_b2)))
go
~~START~~
text
Query Text: /*+ Set(enable_hashjoin off) Set(enable_nestloop off) IndexScan(t1 index_babel_3293_schema_t1_b1t1baa4a261b22c51c48cc060f8d390c3e9) IndexScan(babel_3293_t2 index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e) */ select * from tempdb.babel_3293_schema.t1 join babel_3293_t2 on tempdb.babel_3293_schema.t1.a1 = tempdb.dbo.babel_3293_t2.a2 where b1 = 1 and b2 = 1                                                                                                                                                                       
Merge Join
  Merge Cond: (t1.a1 = babel_3293_t2.a2)
  ->  Sort
        Sort Key: t1.a1
        ->  Index Scan using index_babel_3293_schema_t1_b1t1baa4a261b22c51c48cc060f8d390c3e9 on t1
              Index Cond: (b1 = 1)
  ->  Sort
        Sort Key: babel_3293_t2.a2
        ->  Index Scan using index_babel_3293_t2_b2babel_329ea1aa3a9e72f8fece1b90ee8c2a8f24e on babel_3293_t2
              Index Cond: (b2 = 1)
~~END~~


set babelfish_showplan_all off
go

-- cleanup
drop table babel_3293_schema.t1 
go

drop table babel_3293_t2
go

drop schema babel_3293_schema
go
