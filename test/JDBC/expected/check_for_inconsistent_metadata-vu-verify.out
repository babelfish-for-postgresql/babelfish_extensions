-- psql




-- Deleting one entry from pg_proc pg catalog so that metadata inconsistency fails during check against babelfish_function_ext babelfish catalog
WITH r1 AS (
    SELECT * FROM pg_catalog.pg_proc WHERE proname = 'check_for_inconsistent_metadata_vu_prepare_func'
)
SELECT proname, prosrc FROM r1;
DELETE FROM pg_catalog.pg_proc WHERE proname = 'check_for_inconsistent_metadata_vu_prepare_func';
SELECT proname, prosrc FROM pg_catalog.pg_proc WHERE proname = 'check_for_inconsistent_metadata_vu_prepare_func';
SELECT nspname, funcname FROM sys.babelfish_function_ext WHERE funcname = 'check_for_inconsistent_metadata_vu_prepare_func';
GO
~~START~~
name#!#text
check_for_inconsistent_metadata_vu_prepare_func#!#BEGIN<newline>RETURN (SELECT sys.check_for_inconsistent_metadata())<newline>END
~~END~~

~~ROW COUNT: 1~~

~~START~~
name#!#text
~~END~~

~~START~~
name#!#name
master_dbo#!#check_for_inconsistent_metadata_vu_prepare_func
~~END~~


-- tsql
SELECT sys.check_for_inconsistent_metadata();
GO
~~START~~
bit
1
~~END~~


-- should fail since the function is removed from the catalog
SELECT check_for_inconsistent_metadata_vu_prepare_func()
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: function check_for_inconsistent_metadata_vu_prepare_func() does not exist)~~


SELECT sys.babelfish_inconsistent_metadata()
GO
~~START~~
varchar
(name,pg_catalog,proname,"{""Rule"": ""<funcname> in babelfish_function_ext must also exist in pg_proc""}")
~~END~~

