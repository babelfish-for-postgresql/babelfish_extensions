use pivot_test
GO

-- 2 column in src table pivot
SELECT 'OrderNumbers' AS OrderCountbyStore, [1] AS STORE1, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5
FROM
(
    SELECT StoreID, OrderID
    FROM StoreReceipt
)AS SrcTable
PIVOT (
    COUNT (OrderID)
    FOR StoreID IN ([1], [2], [3],[4], [5])
) AS pvt
ORDER BY 1
GO
~~START~~
text#!#int#!#int#!#int#!#int#!#int
OrderNumbers#!#19#!#19#!#19#!#16#!#14
~~END~~


-- testing trigger with pivot 
insert into trigger_testing (col) select N'Muffler'
GO
~~START~~
varchar#!#int#!#int#!#int#!#int#!#int
OrderNumbers#!#19#!#19#!#19#!#16#!#14
~~END~~

~~ROW COUNT: 1~~


-- 3 column in src table pivot
SELECT EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT EmployeeID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
200#!#0#!#0#!#2#!#0#!#0
201#!#0#!#0#!#0#!#0#!#0
202#!#1#!#0#!#0#!#0#!#0
203#!#0#!#0#!#0#!#1#!#0
204#!#0#!#1#!#0#!#0#!#1
205#!#0#!#0#!#0#!#0#!#1
207#!#0#!#0#!#0#!#0#!#0
208#!#0#!#1#!#0#!#0#!#0
209#!#0#!#1#!#0#!#0#!#0
210#!#0#!#0#!#0#!#0#!#0
211#!#2#!#0#!#0#!#0#!#0
212#!#0#!#0#!#1#!#0#!#0
213#!#0#!#0#!#1#!#0#!#0
214#!#0#!#1#!#0#!#0#!#0
215#!#0#!#0#!#0#!#0#!#0
216#!#0#!#1#!#0#!#0#!#0
217#!#0#!#0#!#0#!#1#!#0
218#!#0#!#0#!#1#!#0#!#0
219#!#1#!#0#!#0#!#0#!#1
220#!#0#!#0#!#0#!#1#!#0
221#!#0#!#0#!#0#!#0#!#0
222#!#0#!#0#!#1#!#1#!#0
223#!#0#!#0#!#0#!#2#!#0
224#!#0#!#0#!#0#!#0#!#1
225#!#0#!#1#!#0#!#1#!#0
226#!#1#!#0#!#0#!#0#!#0
227#!#0#!#0#!#0#!#0#!#1
228#!#0#!#1#!#0#!#0#!#0
229#!#0#!#0#!#1#!#0#!#0
230#!#1#!#1#!#0#!#0#!#0
231#!#0#!#0#!#0#!#0#!#0
232#!#0#!#0#!#0#!#0#!#1
234#!#0#!#0#!#0#!#0#!#1
235#!#0#!#0#!#0#!#0#!#0
236#!#0#!#0#!#1#!#0#!#0
237#!#1#!#0#!#0#!#0#!#0
238#!#0#!#0#!#1#!#0#!#0
239#!#0#!#0#!#0#!#0#!#0
240#!#0#!#0#!#0#!#0#!#0
241#!#0#!#0#!#0#!#0#!#0
243#!#0#!#0#!#0#!#0#!#0
245#!#0#!#0#!#0#!#0#!#0
246#!#0#!#0#!#0#!#0#!#0
247#!#1#!#0#!#0#!#0#!#0
248#!#0#!#0#!#2#!#0#!#0
249#!#1#!#0#!#0#!#0#!#0
250#!#0#!#0#!#0#!#0#!#2
251#!#1#!#1#!#1#!#0#!#0
252#!#0#!#0#!#0#!#0#!#0
253#!#1#!#0#!#0#!#0#!#0
254#!#0#!#1#!#0#!#0#!#0
255#!#0#!#1#!#0#!#0#!#0
256#!#1#!#0#!#0#!#0#!#0
258#!#0#!#0#!#0#!#0#!#0
259#!#0#!#1#!#0#!#1#!#0
260#!#0#!#0#!#0#!#0#!#0
261#!#0#!#0#!#0#!#0#!#0
262#!#0#!#1#!#0#!#0#!#0
264#!#1#!#1#!#0#!#0#!#0
265#!#0#!#0#!#0#!#0#!#0
266#!#0#!#0#!#1#!#0#!#0
267#!#2#!#0#!#0#!#0#!#0
269#!#1#!#2#!#0#!#0#!#0
270#!#0#!#0#!#0#!#0#!#1
271#!#0#!#1#!#0#!#0#!#0
272#!#0#!#0#!#0#!#0#!#0
274#!#0#!#0#!#0#!#0#!#0
275#!#0#!#0#!#0#!#0#!#0
276#!#0#!#0#!#0#!#0#!#0
277#!#0#!#0#!#1#!#1#!#0
278#!#0#!#0#!#0#!#0#!#0
279#!#0#!#0#!#0#!#0#!#0
280#!#0#!#0#!#1#!#0#!#0
282#!#0#!#0#!#0#!#0#!#0
283#!#0#!#0#!#0#!#0#!#0
284#!#0#!#0#!#0#!#0#!#0
285#!#0#!#0#!#0#!#1#!#0
286#!#0#!#0#!#0#!#0#!#0
287#!#0#!#0#!#0#!#1#!#0
288#!#1#!#0#!#0#!#2#!#0
289#!#0#!#0#!#0#!#0#!#1
290#!#0#!#0#!#0#!#0#!#0
291#!#0#!#1#!#0#!#0#!#1
292#!#1#!#0#!#1#!#0#!#0
293#!#0#!#0#!#0#!#0#!#0
294#!#0#!#0#!#0#!#0#!#0
296#!#1#!#0#!#0#!#0#!#0
297#!#0#!#0#!#0#!#1#!#0
298#!#0#!#1#!#0#!#0#!#0
299#!#0#!#0#!#0#!#0#!#0
300#!#0#!#0#!#0#!#0#!#1
~~END~~


-- 3+ column IN src table pivot
SELECT ManufactureID, EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, EmployeeID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int
1200#!#200#!#0#!#0#!#0#!#0#!#0
1200#!#203#!#0#!#0#!#0#!#1#!#0
1200#!#220#!#0#!#0#!#0#!#0#!#0
1200#!#222#!#0#!#0#!#0#!#1#!#0
1200#!#259#!#0#!#0#!#0#!#0#!#0
1200#!#264#!#0#!#1#!#0#!#0#!#0
1200#!#266#!#0#!#0#!#1#!#0#!#0
1200#!#269#!#1#!#0#!#0#!#0#!#0
1201#!#213#!#0#!#0#!#1#!#0#!#0
1201#!#229#!#0#!#0#!#1#!#0#!#0
1201#!#232#!#0#!#0#!#0#!#0#!#0
1201#!#267#!#0#!#0#!#0#!#0#!#0
1202#!#228#!#0#!#0#!#0#!#0#!#0
1202#!#246#!#0#!#0#!#0#!#0#!#0
1202#!#272#!#0#!#0#!#0#!#0#!#0
1202#!#287#!#0#!#0#!#0#!#0#!#0
1202#!#288#!#1#!#0#!#0#!#1#!#0
1203#!#214#!#0#!#0#!#0#!#0#!#0
1203#!#220#!#0#!#0#!#0#!#1#!#0
1203#!#249#!#0#!#0#!#0#!#0#!#0
1203#!#262#!#0#!#0#!#0#!#0#!#0
1204#!#224#!#0#!#0#!#0#!#0#!#1
1204#!#232#!#0#!#0#!#0#!#0#!#0
1204#!#267#!#0#!#0#!#0#!#0#!#0
1204#!#282#!#0#!#0#!#0#!#0#!#0
1204#!#299#!#0#!#0#!#0#!#0#!#0
1205#!#201#!#0#!#0#!#0#!#0#!#0
1205#!#234#!#0#!#0#!#0#!#0#!#1
1206#!#227#!#0#!#0#!#0#!#0#!#0
1206#!#248#!#0#!#0#!#1#!#0#!#0
1206#!#289#!#0#!#0#!#0#!#0#!#1
1207#!#218#!#0#!#0#!#1#!#0#!#0
1207#!#250#!#0#!#0#!#0#!#0#!#1
1207#!#279#!#0#!#0#!#0#!#0#!#0
1208#!#203#!#0#!#0#!#0#!#0#!#0
1208#!#217#!#0#!#0#!#0#!#1#!#0
1208#!#223#!#0#!#0#!#0#!#1#!#0
1208#!#238#!#0#!#0#!#1#!#0#!#0
1208#!#270#!#0#!#0#!#0#!#0#!#0
1209#!#252#!#0#!#0#!#0#!#0#!#0
1209#!#267#!#1#!#0#!#0#!#0#!#0
1210#!#267#!#1#!#0#!#0#!#0#!#0
1210#!#298#!#0#!#1#!#0#!#0#!#0
1211#!#212#!#0#!#0#!#1#!#0#!#0
1211#!#218#!#0#!#0#!#0#!#0#!#0
1211#!#219#!#1#!#0#!#0#!#0#!#0
1211#!#243#!#0#!#0#!#0#!#0#!#0
1212#!#204#!#0#!#1#!#0#!#0#!#0
1212#!#247#!#1#!#0#!#0#!#0#!#0
1212#!#250#!#0#!#0#!#0#!#0#!#1
1212#!#253#!#1#!#0#!#0#!#0#!#0
1213#!#276#!#0#!#0#!#0#!#0#!#0
1213#!#288#!#0#!#0#!#0#!#0#!#0
1213#!#294#!#0#!#0#!#0#!#0#!#0
1214#!#211#!#0#!#0#!#0#!#0#!#0
1214#!#236#!#0#!#0#!#1#!#0#!#0
1214#!#278#!#0#!#0#!#0#!#0#!#0
1214#!#289#!#0#!#0#!#0#!#0#!#0
1214#!#291#!#0#!#0#!#0#!#0#!#1
1214#!#292#!#0#!#0#!#1#!#0#!#0
1214#!#296#!#0#!#0#!#0#!#0#!#0
1215#!#211#!#1#!#0#!#0#!#0#!#0
1215#!#239#!#0#!#0#!#0#!#0#!#0
1215#!#249#!#1#!#0#!#0#!#0#!#0
1215#!#265#!#0#!#0#!#0#!#0#!#0
1215#!#278#!#0#!#0#!#0#!#0#!#0
1215#!#283#!#0#!#0#!#0#!#0#!#0
1215#!#294#!#0#!#0#!#0#!#0#!#0
1216#!#227#!#0#!#0#!#0#!#0#!#0
1217#!#230#!#0#!#1#!#0#!#0#!#0
1217#!#264#!#0#!#0#!#0#!#0#!#0
1217#!#269#!#0#!#1#!#0#!#0#!#0
1217#!#292#!#0#!#0#!#0#!#0#!#0
1218#!#201#!#0#!#0#!#0#!#0#!#0
1218#!#203#!#0#!#0#!#0#!#0#!#0
1218#!#214#!#0#!#0#!#0#!#0#!#0
1218#!#226#!#0#!#0#!#0#!#0#!#0
1218#!#235#!#0#!#0#!#0#!#0#!#0
1218#!#240#!#0#!#0#!#0#!#0#!#0
1218#!#247#!#0#!#0#!#0#!#0#!#0
1218#!#253#!#0#!#0#!#0#!#0#!#0
1218#!#254#!#0#!#1#!#0#!#0#!#0
1219#!#221#!#0#!#0#!#0#!#0#!#0
1219#!#227#!#0#!#0#!#0#!#0#!#0
1220#!#234#!#0#!#0#!#0#!#0#!#0
1220#!#285#!#0#!#0#!#0#!#0#!#0
1220#!#288#!#0#!#0#!#0#!#1#!#0
1221#!#204#!#0#!#0#!#0#!#0#!#1
1221#!#215#!#0#!#0#!#0#!#0#!#0
1221#!#223#!#0#!#0#!#0#!#1#!#0
1221#!#225#!#0#!#0#!#0#!#1#!#0
1221#!#274#!#0#!#0#!#0#!#0#!#0
1222#!#231#!#0#!#0#!#0#!#0#!#0
1223#!#208#!#0#!#0#!#0#!#0#!#0
1223#!#258#!#0#!#0#!#0#!#0#!#0
1223#!#293#!#0#!#0#!#0#!#0#!#0
1224#!#210#!#0#!#0#!#0#!#0#!#0
1224#!#253#!#0#!#0#!#0#!#0#!#0
1225#!#224#!#0#!#0#!#0#!#0#!#0
1225#!#278#!#0#!#0#!#0#!#0#!#0
1226#!#200#!#0#!#0#!#1#!#0#!#0
1226#!#202#!#1#!#0#!#0#!#0#!#0
1226#!#214#!#0#!#1#!#0#!#0#!#0
1226#!#251#!#1#!#0#!#0#!#0#!#0
1226#!#292#!#1#!#0#!#0#!#0#!#0
1227#!#209#!#0#!#0#!#0#!#0#!#0
1227#!#269#!#0#!#1#!#0#!#0#!#0
1228#!#247#!#0#!#0#!#0#!#0#!#0
1228#!#248#!#0#!#0#!#1#!#0#!#0
1229#!#200#!#0#!#0#!#1#!#0#!#0
1229#!#224#!#0#!#0#!#0#!#0#!#0
1229#!#225#!#0#!#1#!#0#!#0#!#0
1229#!#229#!#0#!#0#!#0#!#0#!#0
1229#!#243#!#0#!#0#!#0#!#0#!#0
1229#!#270#!#0#!#0#!#0#!#0#!#1
1229#!#276#!#0#!#0#!#0#!#0#!#0
1231#!#227#!#0#!#0#!#0#!#0#!#1
1231#!#228#!#0#!#1#!#0#!#0#!#0
1231#!#256#!#1#!#0#!#0#!#0#!#0
1231#!#296#!#0#!#0#!#0#!#0#!#0
1232#!#211#!#0#!#0#!#0#!#0#!#0
1232#!#229#!#0#!#0#!#0#!#0#!#0
1233#!#221#!#0#!#0#!#0#!#0#!#0
1233#!#254#!#0#!#0#!#0#!#0#!#0
1233#!#275#!#0#!#0#!#0#!#0#!#0
1234#!#222#!#0#!#0#!#1#!#0#!#0
1234#!#230#!#0#!#0#!#0#!#0#!#0
1234#!#296#!#0#!#0#!#0#!#0#!#0
1235#!#217#!#0#!#0#!#0#!#0#!#0
1235#!#255#!#0#!#0#!#0#!#0#!#0
1235#!#285#!#0#!#0#!#0#!#1#!#0
1236#!#211#!#1#!#0#!#0#!#0#!#0
1236#!#235#!#0#!#0#!#0#!#0#!#0
1236#!#262#!#0#!#1#!#0#!#0#!#0
1236#!#286#!#0#!#0#!#0#!#0#!#0
1237#!#241#!#0#!#0#!#0#!#0#!#0
1237#!#251#!#0#!#1#!#0#!#0#!#0
1237#!#290#!#0#!#0#!#0#!#0#!#0
1237#!#291#!#0#!#1#!#0#!#0#!#0
1238#!#209#!#0#!#1#!#0#!#0#!#0
1238#!#219#!#0#!#0#!#0#!#0#!#1
1238#!#234#!#0#!#0#!#0#!#0#!#0
1238#!#264#!#1#!#0#!#0#!#0#!#0
1238#!#279#!#0#!#0#!#0#!#0#!#0
1238#!#300#!#0#!#0#!#0#!#0#!#1
1239#!#208#!#0#!#1#!#0#!#0#!#0
1239#!#255#!#0#!#0#!#0#!#0#!#0
1239#!#259#!#0#!#0#!#0#!#1#!#0
1239#!#269#!#0#!#0#!#0#!#0#!#0
1239#!#271#!#0#!#1#!#0#!#0#!#0
1239#!#277#!#0#!#0#!#0#!#0#!#0
1240#!#201#!#0#!#0#!#0#!#0#!#0
1240#!#204#!#0#!#0#!#0#!#0#!#0
1240#!#251#!#0#!#0#!#0#!#0#!#0
1240#!#277#!#0#!#0#!#1#!#0#!#0
1240#!#296#!#1#!#0#!#0#!#0#!#0
1241#!#243#!#0#!#0#!#0#!#0#!#0
1241#!#277#!#0#!#0#!#0#!#1#!#0
1241#!#299#!#0#!#0#!#0#!#0#!#0
1242#!#210#!#0#!#0#!#0#!#0#!#0
1242#!#213#!#0#!#0#!#0#!#0#!#0
1242#!#249#!#0#!#0#!#0#!#0#!#0
1242#!#280#!#0#!#0#!#1#!#0#!#0
1242#!#283#!#0#!#0#!#0#!#0#!#0
1242#!#290#!#0#!#0#!#0#!#0#!#0
1243#!#213#!#0#!#0#!#0#!#0#!#0
1243#!#226#!#1#!#0#!#0#!#0#!#0
1243#!#227#!#0#!#0#!#0#!#0#!#0
1243#!#232#!#0#!#0#!#0#!#0#!#0
1243#!#245#!#0#!#0#!#0#!#0#!#0
1243#!#289#!#0#!#0#!#0#!#0#!#0
1244#!#248#!#0#!#0#!#0#!#0#!#0
1244#!#250#!#0#!#0#!#0#!#0#!#0
1245#!#230#!#1#!#0#!#0#!#0#!#0
1245#!#237#!#1#!#0#!#0#!#0#!#0
1245#!#251#!#0#!#0#!#1#!#0#!#0
1245#!#260#!#0#!#0#!#0#!#0#!#0
1245#!#289#!#0#!#0#!#0#!#0#!#0
1245#!#292#!#0#!#0#!#0#!#0#!#0
1246#!#216#!#0#!#1#!#0#!#0#!#0
1246#!#259#!#0#!#1#!#0#!#0#!#0
1246#!#271#!#0#!#0#!#0#!#0#!#0
1246#!#279#!#0#!#0#!#0#!#0#!#0
1246#!#286#!#0#!#0#!#0#!#0#!#0
1246#!#296#!#0#!#0#!#0#!#0#!#0
1247#!#207#!#0#!#0#!#0#!#0#!#0
1247#!#231#!#0#!#0#!#0#!#0#!#0
1247#!#255#!#0#!#1#!#0#!#0#!#0
1247#!#284#!#0#!#0#!#0#!#0#!#0
1248#!#297#!#0#!#0#!#0#!#1#!#0
1249#!#256#!#0#!#0#!#0#!#0#!#0
1249#!#261#!#0#!#0#!#0#!#0#!#0
1250#!#203#!#0#!#0#!#0#!#0#!#0
1250#!#205#!#0#!#0#!#0#!#0#!#1
1250#!#229#!#0#!#0#!#0#!#0#!#0
1250#!#232#!#0#!#0#!#0#!#0#!#1
1250#!#287#!#0#!#0#!#0#!#1#!#0
~~END~~


-- ORDER by test
SELECT  ManufactureID, EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, EmployeeID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER by EmployeeID
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int
1226#!#200#!#0#!#0#!#1#!#0#!#0
1229#!#200#!#0#!#0#!#1#!#0#!#0
1200#!#200#!#0#!#0#!#0#!#0#!#0
1218#!#201#!#0#!#0#!#0#!#0#!#0
1240#!#201#!#0#!#0#!#0#!#0#!#0
1205#!#201#!#0#!#0#!#0#!#0#!#0
1226#!#202#!#1#!#0#!#0#!#0#!#0
1200#!#203#!#0#!#0#!#0#!#1#!#0
1250#!#203#!#0#!#0#!#0#!#0#!#0
1208#!#203#!#0#!#0#!#0#!#0#!#0
1218#!#203#!#0#!#0#!#0#!#0#!#0
1212#!#204#!#0#!#1#!#0#!#0#!#0
1221#!#204#!#0#!#0#!#0#!#0#!#1
1240#!#204#!#0#!#0#!#0#!#0#!#0
1250#!#205#!#0#!#0#!#0#!#0#!#1
1247#!#207#!#0#!#0#!#0#!#0#!#0
1239#!#208#!#0#!#1#!#0#!#0#!#0
1223#!#208#!#0#!#0#!#0#!#0#!#0
1227#!#209#!#0#!#0#!#0#!#0#!#0
1238#!#209#!#0#!#1#!#0#!#0#!#0
1224#!#210#!#0#!#0#!#0#!#0#!#0
1242#!#210#!#0#!#0#!#0#!#0#!#0
1214#!#211#!#0#!#0#!#0#!#0#!#0
1236#!#211#!#1#!#0#!#0#!#0#!#0
1215#!#211#!#1#!#0#!#0#!#0#!#0
1232#!#211#!#0#!#0#!#0#!#0#!#0
1211#!#212#!#0#!#0#!#1#!#0#!#0
1243#!#213#!#0#!#0#!#0#!#0#!#0
1201#!#213#!#0#!#0#!#1#!#0#!#0
1242#!#213#!#0#!#0#!#0#!#0#!#0
1203#!#214#!#0#!#0#!#0#!#0#!#0
1226#!#214#!#0#!#1#!#0#!#0#!#0
1218#!#214#!#0#!#0#!#0#!#0#!#0
1221#!#215#!#0#!#0#!#0#!#0#!#0
1246#!#216#!#0#!#1#!#0#!#0#!#0
1235#!#217#!#0#!#0#!#0#!#0#!#0
1208#!#217#!#0#!#0#!#0#!#1#!#0
1211#!#218#!#0#!#0#!#0#!#0#!#0
1207#!#218#!#0#!#0#!#1#!#0#!#0
1238#!#219#!#0#!#0#!#0#!#0#!#1
1211#!#219#!#1#!#0#!#0#!#0#!#0
1203#!#220#!#0#!#0#!#0#!#1#!#0
1200#!#220#!#0#!#0#!#0#!#0#!#0
1233#!#221#!#0#!#0#!#0#!#0#!#0
1219#!#221#!#0#!#0#!#0#!#0#!#0
1234#!#222#!#0#!#0#!#1#!#0#!#0
1200#!#222#!#0#!#0#!#0#!#1#!#0
1208#!#223#!#0#!#0#!#0#!#1#!#0
1221#!#223#!#0#!#0#!#0#!#1#!#0
1225#!#224#!#0#!#0#!#0#!#0#!#0
1204#!#224#!#0#!#0#!#0#!#0#!#1
1229#!#224#!#0#!#0#!#0#!#0#!#0
1221#!#225#!#0#!#0#!#0#!#1#!#0
1229#!#225#!#0#!#1#!#0#!#0#!#0
1243#!#226#!#1#!#0#!#0#!#0#!#0
1218#!#226#!#0#!#0#!#0#!#0#!#0
1206#!#227#!#0#!#0#!#0#!#0#!#0
1216#!#227#!#0#!#0#!#0#!#0#!#0
1231#!#227#!#0#!#0#!#0#!#0#!#1
1243#!#227#!#0#!#0#!#0#!#0#!#0
1219#!#227#!#0#!#0#!#0#!#0#!#0
1202#!#228#!#0#!#0#!#0#!#0#!#0
1231#!#228#!#0#!#1#!#0#!#0#!#0
1229#!#229#!#0#!#0#!#0#!#0#!#0
1201#!#229#!#0#!#0#!#1#!#0#!#0
1250#!#229#!#0#!#0#!#0#!#0#!#0
1232#!#229#!#0#!#0#!#0#!#0#!#0
1217#!#230#!#0#!#1#!#0#!#0#!#0
1234#!#230#!#0#!#0#!#0#!#0#!#0
1245#!#230#!#1#!#0#!#0#!#0#!#0
1247#!#231#!#0#!#0#!#0#!#0#!#0
1222#!#231#!#0#!#0#!#0#!#0#!#0
1204#!#232#!#0#!#0#!#0#!#0#!#0
1243#!#232#!#0#!#0#!#0#!#0#!#0
1201#!#232#!#0#!#0#!#0#!#0#!#0
1250#!#232#!#0#!#0#!#0#!#0#!#1
1220#!#234#!#0#!#0#!#0#!#0#!#0
1238#!#234#!#0#!#0#!#0#!#0#!#0
1205#!#234#!#0#!#0#!#0#!#0#!#1
1236#!#235#!#0#!#0#!#0#!#0#!#0
1218#!#235#!#0#!#0#!#0#!#0#!#0
1214#!#236#!#0#!#0#!#1#!#0#!#0
1245#!#237#!#1#!#0#!#0#!#0#!#0
1208#!#238#!#0#!#0#!#1#!#0#!#0
1215#!#239#!#0#!#0#!#0#!#0#!#0
1218#!#240#!#0#!#0#!#0#!#0#!#0
1237#!#241#!#0#!#0#!#0#!#0#!#0
1211#!#243#!#0#!#0#!#0#!#0#!#0
1241#!#243#!#0#!#0#!#0#!#0#!#0
1229#!#243#!#0#!#0#!#0#!#0#!#0
1243#!#245#!#0#!#0#!#0#!#0#!#0
1202#!#246#!#0#!#0#!#0#!#0#!#0
1212#!#247#!#1#!#0#!#0#!#0#!#0
1218#!#247#!#0#!#0#!#0#!#0#!#0
1228#!#247#!#0#!#0#!#0#!#0#!#0
1228#!#248#!#0#!#0#!#1#!#0#!#0
1244#!#248#!#0#!#0#!#0#!#0#!#0
1206#!#248#!#0#!#0#!#1#!#0#!#0
1215#!#249#!#1#!#0#!#0#!#0#!#0
1242#!#249#!#0#!#0#!#0#!#0#!#0
1203#!#249#!#0#!#0#!#0#!#0#!#0
1212#!#250#!#0#!#0#!#0#!#0#!#1
1244#!#250#!#0#!#0#!#0#!#0#!#0
1207#!#250#!#0#!#0#!#0#!#0#!#1
1240#!#251#!#0#!#0#!#0#!#0#!#0
1226#!#251#!#1#!#0#!#0#!#0#!#0
1245#!#251#!#0#!#0#!#1#!#0#!#0
1237#!#251#!#0#!#1#!#0#!#0#!#0
1209#!#252#!#0#!#0#!#0#!#0#!#0
1218#!#253#!#0#!#0#!#0#!#0#!#0
1212#!#253#!#1#!#0#!#0#!#0#!#0
1224#!#253#!#0#!#0#!#0#!#0#!#0
1233#!#254#!#0#!#0#!#0#!#0#!#0
1218#!#254#!#0#!#1#!#0#!#0#!#0
1247#!#255#!#0#!#1#!#0#!#0#!#0
1235#!#255#!#0#!#0#!#0#!#0#!#0
1239#!#255#!#0#!#0#!#0#!#0#!#0
1249#!#256#!#0#!#0#!#0#!#0#!#0
1231#!#256#!#1#!#0#!#0#!#0#!#0
1223#!#258#!#0#!#0#!#0#!#0#!#0
1246#!#259#!#0#!#1#!#0#!#0#!#0
1200#!#259#!#0#!#0#!#0#!#0#!#0
1239#!#259#!#0#!#0#!#0#!#1#!#0
1245#!#260#!#0#!#0#!#0#!#0#!#0
1249#!#261#!#0#!#0#!#0#!#0#!#0
1203#!#262#!#0#!#0#!#0#!#0#!#0
1236#!#262#!#0#!#1#!#0#!#0#!#0
1200#!#264#!#0#!#1#!#0#!#0#!#0
1238#!#264#!#1#!#0#!#0#!#0#!#0
1217#!#264#!#0#!#0#!#0#!#0#!#0
1215#!#265#!#0#!#0#!#0#!#0#!#0
1200#!#266#!#0#!#0#!#1#!#0#!#0
1210#!#267#!#1#!#0#!#0#!#0#!#0
1201#!#267#!#0#!#0#!#0#!#0#!#0
1209#!#267#!#1#!#0#!#0#!#0#!#0
1204#!#267#!#0#!#0#!#0#!#0#!#0
1239#!#269#!#0#!#0#!#0#!#0#!#0
1200#!#269#!#1#!#0#!#0#!#0#!#0
1217#!#269#!#0#!#1#!#0#!#0#!#0
1227#!#269#!#0#!#1#!#0#!#0#!#0
1208#!#270#!#0#!#0#!#0#!#0#!#0
1229#!#270#!#0#!#0#!#0#!#0#!#1
1246#!#271#!#0#!#0#!#0#!#0#!#0
1239#!#271#!#0#!#1#!#0#!#0#!#0
1202#!#272#!#0#!#0#!#0#!#0#!#0
1221#!#274#!#0#!#0#!#0#!#0#!#0
1233#!#275#!#0#!#0#!#0#!#0#!#0
1229#!#276#!#0#!#0#!#0#!#0#!#0
1213#!#276#!#0#!#0#!#0#!#0#!#0
1240#!#277#!#0#!#0#!#1#!#0#!#0
1239#!#277#!#0#!#0#!#0#!#0#!#0
1241#!#277#!#0#!#0#!#0#!#1#!#0
1225#!#278#!#0#!#0#!#0#!#0#!#0
1215#!#278#!#0#!#0#!#0#!#0#!#0
1214#!#278#!#0#!#0#!#0#!#0#!#0
1207#!#279#!#0#!#0#!#0#!#0#!#0
1246#!#279#!#0#!#0#!#0#!#0#!#0
1238#!#279#!#0#!#0#!#0#!#0#!#0
1242#!#280#!#0#!#0#!#1#!#0#!#0
1204#!#282#!#0#!#0#!#0#!#0#!#0
1242#!#283#!#0#!#0#!#0#!#0#!#0
1215#!#283#!#0#!#0#!#0#!#0#!#0
1247#!#284#!#0#!#0#!#0#!#0#!#0
1220#!#285#!#0#!#0#!#0#!#0#!#0
1235#!#285#!#0#!#0#!#0#!#1#!#0
1236#!#286#!#0#!#0#!#0#!#0#!#0
1246#!#286#!#0#!#0#!#0#!#0#!#0
1250#!#287#!#0#!#0#!#0#!#1#!#0
1202#!#287#!#0#!#0#!#0#!#0#!#0
1202#!#288#!#1#!#0#!#0#!#1#!#0
1220#!#288#!#0#!#0#!#0#!#1#!#0
1213#!#288#!#0#!#0#!#0#!#0#!#0
1245#!#289#!#0#!#0#!#0#!#0#!#0
1206#!#289#!#0#!#0#!#0#!#0#!#1
1243#!#289#!#0#!#0#!#0#!#0#!#0
1214#!#289#!#0#!#0#!#0#!#0#!#0
1237#!#290#!#0#!#0#!#0#!#0#!#0
1242#!#290#!#0#!#0#!#0#!#0#!#0
1214#!#291#!#0#!#0#!#0#!#0#!#1
1237#!#291#!#0#!#1#!#0#!#0#!#0
1245#!#292#!#0#!#0#!#0#!#0#!#0
1226#!#292#!#1#!#0#!#0#!#0#!#0
1217#!#292#!#0#!#0#!#0#!#0#!#0
1214#!#292#!#0#!#0#!#1#!#0#!#0
1223#!#293#!#0#!#0#!#0#!#0#!#0
1213#!#294#!#0#!#0#!#0#!#0#!#0
1215#!#294#!#0#!#0#!#0#!#0#!#0
1246#!#296#!#0#!#0#!#0#!#0#!#0
1214#!#296#!#0#!#0#!#0#!#0#!#0
1231#!#296#!#0#!#0#!#0#!#0#!#0
1240#!#296#!#1#!#0#!#0#!#0#!#0
1234#!#296#!#0#!#0#!#0#!#0#!#0
1248#!#297#!#0#!#0#!#0#!#1#!#0
1210#!#298#!#0#!#1#!#0#!#0#!#0
1204#!#299#!#0#!#0#!#0#!#0#!#0
1241#!#299#!#0#!#0#!#0#!#0#!#0
1238#!#300#!#0#!#0#!#0#!#0#!#1
~~END~~


-- whereclause test
SELECT  ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
WHERE ManufactureID < 1220
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
1205#!#0#!#0#!#0#!#0#!#1
1206#!#0#!#0#!#1#!#0#!#1
1207#!#0#!#0#!#1#!#0#!#1
1208#!#0#!#0#!#1#!#2#!#0
1209#!#1#!#0#!#0#!#0#!#0
1210#!#1#!#1#!#0#!#0#!#0
1211#!#1#!#0#!#1#!#0#!#0
1212#!#2#!#1#!#0#!#0#!#1
1213#!#0#!#0#!#0#!#0#!#0
1214#!#0#!#0#!#2#!#0#!#1
1215#!#2#!#0#!#0#!#0#!#0
1216#!#0#!#0#!#0#!#0#!#0
1217#!#0#!#2#!#0#!#0#!#0
1218#!#0#!#1#!#0#!#0#!#0
1219#!#0#!#0#!#0#!#0#!#0
~~END~~


-- groupby, having clause test
SELECT EmployeeID, ManufactureID, [2] AS STORE2
FROM
(
    SELECT EmployeeID, ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
WHERE EmployeeID < 210
group by EmployeeID, ManufactureID, [2]
having ManufactureID < 1250
ORDER by 1,2
GO
~~START~~
int#!#int#!#int
200#!#1200#!#0
200#!#1226#!#0
200#!#1229#!#0
201#!#1205#!#0
201#!#1218#!#0
201#!#1240#!#0
202#!#1226#!#1
203#!#1200#!#0
203#!#1208#!#0
203#!#1218#!#0
204#!#1212#!#0
204#!#1221#!#0
204#!#1240#!#0
207#!#1247#!#0
208#!#1223#!#0
208#!#1239#!#0
209#!#1227#!#0
209#!#1238#!#0
~~END~~



-- TOP test
SELECT TOP 5 ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
~~END~~


-- distinct test 
SELECT distinct ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
1205#!#0#!#0#!#0#!#0#!#1
1206#!#0#!#0#!#1#!#0#!#1
1207#!#0#!#0#!#1#!#0#!#1
1208#!#0#!#0#!#1#!#2#!#0
1209#!#1#!#0#!#0#!#0#!#0
1210#!#1#!#1#!#0#!#0#!#0
1211#!#1#!#0#!#1#!#0#!#0
1212#!#2#!#1#!#0#!#0#!#1
1213#!#0#!#0#!#0#!#0#!#0
1214#!#0#!#0#!#2#!#0#!#1
1215#!#2#!#0#!#0#!#0#!#0
1216#!#0#!#0#!#0#!#0#!#0
1217#!#0#!#2#!#0#!#0#!#0
1218#!#0#!#1#!#0#!#0#!#0
1219#!#0#!#0#!#0#!#0#!#0
1220#!#0#!#0#!#0#!#1#!#0
1221#!#0#!#0#!#0#!#2#!#1
1222#!#0#!#0#!#0#!#0#!#0
1223#!#0#!#0#!#0#!#0#!#0
1224#!#0#!#0#!#0#!#0#!#0
1225#!#0#!#0#!#0#!#0#!#0
1226#!#3#!#1#!#1#!#0#!#0
1227#!#0#!#1#!#0#!#0#!#0
1228#!#0#!#0#!#1#!#0#!#0
1229#!#0#!#1#!#1#!#0#!#1
1231#!#1#!#1#!#0#!#0#!#1
1232#!#0#!#0#!#0#!#0#!#0
1233#!#0#!#0#!#0#!#0#!#0
1234#!#0#!#0#!#1#!#0#!#0
1235#!#0#!#0#!#0#!#1#!#0
1236#!#1#!#1#!#0#!#0#!#0
1237#!#0#!#2#!#0#!#0#!#0
1238#!#1#!#1#!#0#!#0#!#2
1239#!#0#!#2#!#0#!#1#!#0
1240#!#1#!#0#!#1#!#0#!#0
1241#!#0#!#0#!#0#!#1#!#0
1242#!#0#!#0#!#1#!#0#!#0
1243#!#1#!#0#!#0#!#0#!#0
1244#!#0#!#0#!#0#!#0#!#0
1245#!#2#!#0#!#1#!#0#!#0
1246#!#0#!#2#!#0#!#0#!#0
1247#!#0#!#1#!#0#!#0#!#0
1248#!#0#!#0#!#0#!#1#!#0
1249#!#0#!#0#!#0#!#0#!#0
1250#!#0#!#0#!#0#!#1#!#2
~~END~~



-- INSERT INTO test
INSERT INTO pivot_insert_into
SELECT  ManufactureID, EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, EmployeeID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
SELECT TOP 10 * FROM pivot_insert_into ORDER by 1, 2;
GO
~~ROW COUNT: 197~~

~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int
1200#!#200#!#0#!#0#!#0#!#0#!#0
1200#!#203#!#0#!#0#!#0#!#1#!#0
1200#!#220#!#0#!#0#!#0#!#0#!#0
1200#!#222#!#0#!#0#!#0#!#1#!#0
1200#!#259#!#0#!#0#!#0#!#0#!#0
1200#!#264#!#0#!#1#!#0#!#0#!#0
1200#!#266#!#0#!#0#!#1#!#0#!#0
1200#!#269#!#1#!#0#!#0#!#0#!#0
1201#!#213#!#0#!#0#!#1#!#0#!#0
1201#!#229#!#0#!#0#!#1#!#0#!#0
~~END~~



-- SELECT INTO test
SELECT ManufactureID, EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
INTO pivot_SELECT_into
FROM
(
    SELECT ManufactureID, EmployeeID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
SELECT TOP 10 * FROM pivot_SELECT_into ORDER by 1, 2;
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int
1200#!#200#!#0#!#0#!#0#!#0#!#0
1200#!#203#!#0#!#0#!#0#!#1#!#0
1200#!#220#!#0#!#0#!#0#!#0#!#0
1200#!#222#!#0#!#0#!#0#!#1#!#0
1200#!#259#!#0#!#0#!#0#!#0#!#0
1200#!#264#!#0#!#1#!#0#!#0#!#0
1200#!#266#!#0#!#0#!#1#!#0#!#0
1200#!#269#!#1#!#0#!#0#!#0#!#0
1201#!#213#!#0#!#0#!#1#!#0#!#0
1201#!#229#!#0#!#0#!#1#!#0#!#0
~~END~~


-- union test
SELECT TOP 5 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT EmployeeID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
UNION
SELECT TOP 5 ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt2
ORDER by 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
200#!#0#!#0#!#2#!#0#!#0
201#!#0#!#0#!#0#!#0#!#0
202#!#1#!#0#!#0#!#0#!#0
203#!#0#!#0#!#0#!#1#!#0
204#!#0#!#1#!#0#!#0#!#1
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
~~END~~


-- sub query test
SELECT TOP 3 * FROM (
    SELECT ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT ManufactureID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt2
) p
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
~~END~~


-- table variable test
DECLARE  @pivot_table_var TABLE (
	ManufactureID INT,
    ItemID INT,
	StoreID INT
);
INSERT INTO @pivot_table_var SELECT ManufactureID, ItemID, StoreID FROM StoreReceipt;
SELECT TOP 5 ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
    @pivot_table_var
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt2
ORDER BY 1
GO
~~ROW COUNT: 200~~

~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
~~END~~


-- temp table test
SELECT ManufactureID, ItemID, StoreID INTO #pivot_temp_table FROM StoreReceipt;
SELECT TOP 5 ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
    #pivot_temp_table
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt2
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
~~END~~


-- procedure test
exec top_n_pivot 10
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
1205#!#0#!#0#!#0#!#0#!#1
1206#!#0#!#0#!#1#!#0#!#1
1207#!#0#!#0#!#1#!#0#!#1
1208#!#0#!#0#!#1#!#2#!#0
1209#!#1#!#0#!#0#!#0#!#0
~~END~~


exec top_n_pivot 5
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
~~END~~


-- function test
SELECT * FROM test_table_valued_function(12) ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
1205#!#0#!#0#!#0#!#0#!#1
1206#!#0#!#0#!#1#!#0#!#1
1207#!#0#!#0#!#1#!#0#!#1
1208#!#0#!#0#!#1#!#2#!#0
1209#!#1#!#0#!#0#!#0#!#0
1210#!#1#!#1#!#0#!#0#!#0
1211#!#1#!#0#!#1#!#0#!#0
~~END~~


SELECT * FROM test_table_valued_function(2) ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
~~END~~


-- explain pivot
SET BABELFISH_SHOWPLAN_ALL ON;
SELECT TOP 5 ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
GO
~~START~~
text
Query Text: SELECT TOP 5 ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
Limit  (cost=26.61..26.62 rows=5 width=24)
  ->  Sort  (cost=26.61..29.11 rows=1000 width=24)
        Sort Key: "ManufactureID" NULLS FIRST
        ->  Function Scan on bbf_pivot pvt  (cost=0.00..10.00 rows=1000 width=24)
~~END~~

SET BABELFISH_SHOWPLAN_ALL OFF;
GO


-- test column name with indirection (value column)
SELECT TOP 5 ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (srctable.ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
~~END~~


-- test column name win indirection (category column)
SELECT TOP 5 ManufactureID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT ManufactureID, ItemID, StoreID
    FROM StoreReceipt
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR srctable.StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
1200#!#1#!#1#!#1#!#2#!#0
1201#!#0#!#0#!#2#!#0#!#0
1202#!#1#!#0#!#0#!#1#!#0
1203#!#0#!#0#!#0#!#1#!#0
1204#!#0#!#0#!#0#!#0#!#1
~~END~~


-- CTE test data
CREATE TABLE #FruitSales
(FruitType VARCHAR(20), SalesYear INT, FruitSales MONEY);
GO

INSERT INTO #FruitSales VALUES('Orange', 2024, 23425);
INSERT INTO #FruitSales VALUES('Orange', 2024, 54234);
INSERT INTO #FruitSales VALUES('Orange', 2023, 12490);
INSERT INTO #FruitSales VALUES('Orange', 2023, 4535);
INSERT INTO #FruitSales VALUES('Banana', 2024, 45745);
INSERT INTO #FruitSales VALUES('Banana', 2024, 5636);
INSERT INTO #FruitSales VALUES('Banana', 2023, 24654);
INSERT INTO #FruitSales VALUES('Banana', 2023, 6547);
GO
~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~

~~ROW COUNT: 1~~


-- CTE test 1
WITH
SalesTotal AS
(
SELECT FruitType,
  [2023] AS [2023_Total],
  [2024] AS [2024_Total]
FROM #FruitSales
  PIVOT(SUM(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
),
SalesAvg AS
(
SELECT FruitType,
  [2023] AS [2023_Avg],
  [2024] AS [2024_Avg]
FROM #FruitSales
  PIVOT(AVG(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
)
SELECT st.FruitType, st.[2023_Total], sa.[2023_Avg],
  st.[2024_Total], sa.[2024_Avg]
FROM SalesTotal AS st
  INNER JOIN SalesAvg AS sa
  ON st.FruitType = sa.FruitType
ORDER BY 1
GO
~~START~~
varchar#!#money#!#money#!#money#!#money
Banana#!#31201.0000#!#15600.5000#!#51381.0000#!#25690.5000
Orange#!#17025.0000#!#8512.5000#!#77659.0000#!#38829.5000
~~END~~


-- CTE test 2
WITH
SalesTotal AS
(
SELECT FruitType,
  [2023] AS [2023_Total],
  [2024] AS [2024_Total]
FROM #FruitSales
  PIVOT(SUM(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
),
SalesAvg AS
(
SELECT FruitType,
  [2023] AS [2023_Avg],
  [2024] AS [2024_Avg]
FROM #FruitSales
  PIVOT(AVG(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
)
SELECT * from SalesTotal ORDER BY FruitType;
GO
~~START~~
varchar#!#money#!#money
Banana#!#31201.0000#!#51381.0000
Orange#!#17025.0000#!#77659.0000
~~END~~


-- CTE test 3
WITH
SalesTotal AS
(
SELECT FruitType,
  [2023] AS [2023_Total],
  [2024] AS [2024_Total]
FROM #FruitSales
  PIVOT(SUM(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
),
SalesAvg AS
(
SELECT FruitType,
  [2023] AS [2023_Avg],
  [2024] AS [2024_Avg]
FROM #FruitSales
  PIVOT(AVG(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
)
SELECT * from SalesAvg ORDER BY FruitType;
GO
~~START~~
varchar#!#money#!#money
Banana#!#15600.5000#!#25690.5000
Orange#!#8512.5000#!#38829.5000
~~END~~


-- CTE of 3 expression table
WITH
SalesTotal AS
(
SELECT FruitType,
  [2023] AS [2023_Total],
  [2024] AS [2024_Total]
FROM #FruitSales
  PIVOT(SUM(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
),
SalesAvg AS
(
SELECT FruitType,
  [2023] AS [2023_Avg],
  [2024] AS [2024_Avg]
FROM #FruitSales
  PIVOT(AVG(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
),
SalesMin AS
(
SELECT FruitType,
  [2023] AS [2023_min],
  [2024] AS [2024_min]
FROM #FruitSales
  PIVOT(MIN(FruitSales)
  FOR SalesYear IN([2023], [2024])
  ) AS PivotSales
)
SELECT st.FruitType, st.[2023_Total], sa.[2023_Avg],
  st.[2024_Total], sa.[2024_Avg], sm.[2023_min],sm.[2024_min]
FROM SalesTotal AS st
  INNER JOIN SalesAvg AS sa
  ON st.FruitType = sa.FruitType
  INNER JOIN SalesMin as sm
  ON sa.FruitType = sm.FruitType
ORDER BY 1
GO
~~START~~
varchar#!#money#!#money#!#money#!#money#!#money#!#money
Banana#!#31201.0000#!#15600.5000#!#51381.0000#!#25690.5000#!#6547.0000#!#5636.0000
Orange#!#17025.0000#!#8512.5000#!#77659.0000#!#38829.5000#!#4535.0000#!#23425.0000
~~END~~


-- Test stmt of CTE table and PIVOT stmt in different level 
WITH
SalesTotal AS
(
    SELECT FruitType,
        [2023] AS [2023_Total],
        [2024] AS [2024_Total]
    FROM #FruitSales
    PIVOT(SUM(FruitSales)
    FOR SalesYear IN([2023], [2024])
    ) AS PivotSales
)
SELECT st.FruitType, st.[2023_Total], sa.[2023_Avg],
  st.[2024_Total], sa.[2024_Avg]
FROM SalesTotal AS st
JOIN (
    SELECT FruitType,
        [2023] AS [2023_Avg],
        [2024] AS [2024_Avg]
    FROM #FruitSales
    PIVOT(AVG(FruitSales)
    FOR SalesYear IN([2023], [2024])
    ) AS PivotSales
) sa ON st.FruitType = sa.FruitType;
GO
~~START~~
varchar#!#money#!#money#!#money#!#money
Banana#!#31201.0000#!#15600.5000#!#51381.0000#!#25690.5000
Orange#!#17025.0000#!#8512.5000#!#77659.0000#!#38829.5000
~~END~~


DROP TABlE IF EXISTS #FruitSales
GO

-- PIVOT with CTE as source table
WITH cte_table AS (
    SELECT [p].productName, [o].[employeeName]
    FROM orders [o] JOIN products AS [p] on (o.productId = p.productId)
)
SELECT CAST('COUNT' AS VARCHAR(10)), [mac],[ipad],[charger] FROM cte_table
PIVOT (
    COUNT(employeeName)
    FOR productName IN (mac, [iphone], [ipad], [charger])
) as pvt
GO
~~START~~
varchar#!#int#!#int#!#int
COUNT#!#7#!#4#!#1
~~END~~


-- string is not allowed in PIVOT column value list
WITH cte_table AS (
    SELECT o.[orderId], o.[productId], [p].productName,
        [p].productPrice, [o].[employeeName], [o].employeeCode, [o].date
    FROM orders [o] JOIN products AS [p] on (o.productId = p.productId)
)
SELECT * FROM cte_table
PIVOT (
    COUNT(orderId)
    FOR productName IN ('mac', 'iphone', 'ipad', 'charger')
) as p
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: syntax error at or near "'mac'")~~


-- aggregate column in PIVOT column value list is not allowed
WITH cte_table AS
(
  SELECT
    CAST('COUNT' AS VARCHAR(10)) AS COUNT,
    [mac], [ipad], [charger], [employeeName]
  FROM (
    SELECT [o].employeeName, [p].productName
    FROM orders [o] JOIN products AS [p] on ([o].productId = [p].productId)
  ) AS dervied_table
PIVOT
  (
      COUNT(employeeName)
      FOR productName IN ([mac], [employeeName], [iphone], [ipad], [charger])
  ) as pvt
)
SELECT * FROM cte_table
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: The column name "employeename" specified in the PIVOT operator conflicts with the existing column name in the PIVOT argument.)~~


-- Join stmts inside PIVOT statment (BABEL-4558)
SELECT Oid, [1] AS TYPE1, [2] AS TYPE2, [3] AS TYPE3
FROM (SELECT OSTable.Oid, STable.Scode, STable.Type
        FROM OSTable
        INNER JOIN STable
        ON OSTable.Sid = STable.Id
        ) AS SourceTable
PIVOT ( MAX(Scode) FOR [Type] IN ([1], [2], [3]))
        AS os_pivot
ORDER BY 1
GO
~~START~~
int#!#varchar#!#varchar#!#varchar
1#!#<NULL>#!#<NULL>#!#<NULL>
2#!#<NULL>#!#<NULL>#!#<NULL>
3#!#<NULL>#!#<NULL>#!#<NULL>
4#!#<NULL>#!#<NULL>#!#<NULL>
5#!#<NULL>#!#luctus#!#<NULL>
6#!#<NULL>#!#<NULL>#!#<NULL>
7#!#<NULL>#!#<NULL>#!#<NULL>
8#!#<NULL>#!#<NULL>#!#<NULL>
9#!#<NULL>#!#<NULL>#!#<NULL>
10#!#<NULL>#!#<NULL>#!#<NULL>
~~END~~


-- JOIN TEST
SELECT * FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
JOIN
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
ON p1.EmployeeID = p2.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int
251#!#1#!#1#!#1#!#0#!#0#!#251#!#0#!#0#!#0#!#0
252#!#0#!#0#!#0#!#0#!#0#!#252#!#1#!#0#!#0#!#0
253#!#1#!#0#!#0#!#0#!#0#!#253#!#1#!#0#!#1#!#0
254#!#0#!#1#!#0#!#0#!#0#!#254#!#0#!#0#!#0#!#0
255#!#0#!#1#!#0#!#0#!#0#!#255#!#0#!#2#!#0#!#0
~~END~~


-- INNER JOIN TEST
SELECT * FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
INNER JOIN
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
ON p1.EmployeeID = p2.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int
251#!#1#!#1#!#1#!#0#!#0#!#251#!#0#!#0#!#0#!#0
252#!#0#!#0#!#0#!#0#!#0#!#252#!#1#!#0#!#0#!#0
253#!#1#!#0#!#0#!#0#!#0#!#253#!#1#!#0#!#1#!#0
254#!#0#!#1#!#0#!#0#!#0#!#254#!#0#!#0#!#0#!#0
255#!#0#!#1#!#0#!#0#!#0#!#255#!#0#!#2#!#0#!#0
~~END~~


-- LEFT JOIN TEST
SELECT * FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
LEFT JOIN
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
ON p1.EmployeeID = p2.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int
251#!#1#!#1#!#1#!#0#!#0#!#251#!#0#!#0#!#0#!#0
252#!#0#!#0#!#0#!#0#!#0#!#252#!#1#!#0#!#0#!#0
253#!#1#!#0#!#0#!#0#!#0#!#253#!#1#!#0#!#1#!#0
254#!#0#!#1#!#0#!#0#!#0#!#254#!#0#!#0#!#0#!#0
255#!#0#!#1#!#0#!#0#!#0#!#255#!#0#!#2#!#0#!#0
256#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
258#!#0#!#0#!#0#!#0#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
259#!#0#!#1#!#0#!#1#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
260#!#0#!#0#!#0#!#0#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
261#!#0#!#0#!#0#!#0#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
~~END~~


-- RIGHT JOIN TEST
SELECT * FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
RIGHT JOIN
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
ON p1.EmployeeID = p2.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#246#!#0#!#1#!#0#!#0
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#247#!#0#!#0#!#2#!#0
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#248#!#0#!#0#!#0#!#1
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#249#!#1#!#1#!#0#!#0
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#250#!#0#!#0#!#0#!#1
251#!#1#!#1#!#1#!#0#!#0#!#251#!#0#!#0#!#0#!#0
252#!#0#!#0#!#0#!#0#!#0#!#252#!#1#!#0#!#0#!#0
253#!#1#!#0#!#0#!#0#!#0#!#253#!#1#!#0#!#1#!#0
254#!#0#!#1#!#0#!#0#!#0#!#254#!#0#!#0#!#0#!#0
255#!#0#!#1#!#0#!#0#!#0#!#255#!#0#!#2#!#0#!#0
~~END~~


-- FULL JOIN TEST
SELECT * FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
FULL JOIN
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
ON p1.EmployeeID = p2.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#250#!#0#!#0#!#0#!#1
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#247#!#0#!#0#!#2#!#0
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#246#!#0#!#1#!#0#!#0
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#248#!#0#!#0#!#0#!#1
<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#249#!#1#!#1#!#0#!#0
251#!#1#!#1#!#1#!#0#!#0#!#251#!#0#!#0#!#0#!#0
252#!#0#!#0#!#0#!#0#!#0#!#252#!#1#!#0#!#0#!#0
253#!#1#!#0#!#0#!#0#!#0#!#253#!#1#!#0#!#1#!#0
254#!#0#!#1#!#0#!#0#!#0#!#254#!#0#!#0#!#0#!#0
255#!#0#!#1#!#0#!#0#!#0#!#255#!#0#!#2#!#0#!#0
256#!#1#!#0#!#0#!#0#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
258#!#0#!#0#!#0#!#0#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
259#!#0#!#1#!#0#!#1#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
260#!#0#!#0#!#0#!#0#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
261#!#0#!#0#!#0#!#0#!#0#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>#!#<NULL>
~~END~~


-- CROSS JOIN TEST
SELECT * FROM
(
    SELECT TOP 5 EmployeeID, [2] AS STORE2
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
CROSS JOIN
(
    SELECT TOP 5 EmployeeID, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2 ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int
251#!#1#!#246#!#0
251#!#1#!#247#!#0
251#!#1#!#248#!#1
251#!#1#!#249#!#0
251#!#1#!#250#!#1
252#!#0#!#246#!#0
252#!#0#!#247#!#0
252#!#0#!#248#!#1
252#!#0#!#249#!#0
252#!#0#!#250#!#1
253#!#1#!#246#!#0
253#!#1#!#247#!#0
253#!#1#!#248#!#1
253#!#1#!#249#!#0
253#!#1#!#250#!#1
254#!#0#!#246#!#0
254#!#0#!#247#!#0
254#!#0#!#248#!#1
254#!#0#!#249#!#0
254#!#0#!#250#!#1
255#!#0#!#246#!#0
255#!#0#!#247#!#0
255#!#0#!#248#!#1
255#!#0#!#249#!#0
255#!#0#!#250#!#1
~~END~~


-- COMMA JOIN TEST
SELECT * FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
,
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
WHERE p1.EmployeeID = p2.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int
251#!#1#!#1#!#1#!#0#!#0#!#251#!#0#!#0#!#0#!#0
252#!#0#!#0#!#0#!#0#!#0#!#252#!#1#!#0#!#0#!#0
253#!#1#!#0#!#0#!#0#!#0#!#253#!#1#!#0#!#1#!#0
254#!#0#!#1#!#0#!#0#!#0#!#254#!#0#!#0#!#0#!#0
255#!#0#!#1#!#0#!#0#!#0#!#255#!#0#!#2#!#0#!#0
~~END~~


-- COMMA CROSS JOIN TEST
SELECT * FROM
(
    SELECT TOP 5 EmployeeID, [2] AS STORE2
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
,
(
    SELECT TOP 5 EmployeeID, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2 ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int
251#!#1#!#246#!#0
251#!#1#!#247#!#0
251#!#1#!#248#!#1
251#!#1#!#249#!#0
251#!#1#!#250#!#1
252#!#0#!#246#!#0
252#!#0#!#247#!#0
252#!#0#!#248#!#1
252#!#0#!#249#!#0
252#!#0#!#250#!#1
253#!#1#!#246#!#0
253#!#1#!#247#!#0
253#!#1#!#248#!#1
253#!#1#!#249#!#0
253#!#1#!#250#!#1
254#!#0#!#246#!#0
254#!#0#!#247#!#0
254#!#0#!#248#!#1
254#!#0#!#249#!#0
254#!#0#!#250#!#1
255#!#0#!#246#!#0
255#!#0#!#247#!#0
255#!#0#!#248#!#1
255#!#0#!#249#!#0
255#!#0#!#250#!#1
~~END~~


--3+ JOIN TEST
SELECT * FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
JOIN
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
ON p1.EmployeeID = p2.EmployeeID
JOIN
(
    SELECT TOP 10 EmployeeID, [1] AS STORE1
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([1])
    ) AS pvt where EmployeeID > 248
)AS p3
ON p2.EmployeeID = p3.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int
251#!#1#!#1#!#1#!#0#!#0#!#251#!#0#!#0#!#0#!#0#!#251#!#1
252#!#0#!#0#!#0#!#0#!#0#!#252#!#1#!#0#!#0#!#0#!#252#!#0
253#!#1#!#0#!#0#!#0#!#0#!#253#!#1#!#0#!#1#!#0#!#253#!#0
254#!#0#!#1#!#0#!#0#!#0#!#254#!#0#!#0#!#0#!#0#!#254#!#1
255#!#0#!#1#!#0#!#0#!#0#!#255#!#0#!#2#!#0#!#0#!#255#!#0
~~END~~



-- Result Order Test
-- JOIN A
SELECT p2.EmployeeID, STORE7, STORE8, STORE9, STORE10 FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
JOIN
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
ON p1.EmployeeID = p2.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int
251#!#0#!#0#!#0#!#0
252#!#1#!#0#!#0#!#0
253#!#1#!#0#!#1#!#0
254#!#0#!#0#!#0#!#0
255#!#0#!#2#!#0#!#0
~~END~~


-- JOIN B (Reference)
SELECT * FROM
(
    SELECT TOP 10 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([2], [3], [4], [5], [6])
    ) AS pvt where EmployeeID > 250
) AS p1
JOIN
(
    SELECT TOP 10 EmployeeID, [7] AS STORE7, [8] AS STORE8, [9] AS STORE9, [10] AS STORE10
    FROM
    (
        SELECT EmployeeID, ItemID, StoreID
        FROM StoreReceipt
    )AS srctable
    PIVOT (
        COUNT (srctable.ItemID)
        FOR StoreID IN ([7], [8], [9], [10])
    ) AS pvt where EmployeeID > 245
) AS p2
ON p1.EmployeeID = p2.EmployeeID ORDER BY 1
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int#!#int
251#!#1#!#1#!#1#!#0#!#0#!#251#!#0#!#0#!#0#!#0
252#!#0#!#0#!#0#!#0#!#0#!#252#!#1#!#0#!#0#!#0
253#!#1#!#0#!#0#!#0#!#0#!#253#!#1#!#0#!#1#!#0
254#!#0#!#1#!#0#!#0#!#0#!#254#!#0#!#0#!#0#!#0
255#!#0#!#1#!#0#!#0#!#0#!#255#!#0#!#2#!#0#!#0
~~END~~


-- Test view as a data source in a stmt with pivot operator
SELECT TOP 5 EmployeeID, [2] AS STORE2, [3] AS STORE3, [4] AS STORE4, [5] AS STORE5, [6] AS STORE6
FROM
(
    SELECT EmployeeID, ItemID, StoreID
    FROM StoreReceipt_view
)AS srctable
PIVOT (
    COUNT (ItemID)
    FOR StoreID IN ([2], [3], [4], [5], [6])
) AS pvt
GO
~~START~~
int#!#int#!#int#!#int#!#int#!#int
200#!#0#!#0#!#2#!#0#!#0
201#!#0#!#0#!#0#!#0#!#0
202#!#1#!#0#!#0#!#0#!#0
203#!#0#!#0#!#0#!#1#!#0
204#!#0#!#1#!#0#!#0#!#1
~~END~~


-- Test view of a stmt with pivot operator
-- Expected to fail since we failed to create view with pivot at prepare script. 
-- Create view with pivot is not yet supported,
SELECT ManufactureID, STORE2, STORE3, STORE4, STORE5, STORE6
FROM pivot_view
ORDER BY ManufactureID
GO
~~ERROR (Code: 33557097)~~

~~ERROR (Message: relation "pivot_view" does not exist)~~


-- aggregate string value, when no row is selected, should output NULL
SELECT [seatings], [LEFT], [RIGHT] 
FROM
(
    SELECT [seatings], left_right 
    FROM seating_tbl
) AS p1
PIVOT (
    MAX(left_right) 
    FOR left_right IN ([LEFT], [RIGHT]) 
) AS p2
ORDER BY 1
GO
~~START~~
varchar#!#varchar#!#varchar
SEAT1#!#LEFT#!#RIGHT
SEAT2#!#LEFT#!#<NULL>
SEAT3#!#LEFT#!#RIGHT
~~END~~


-- test pivot with table in different schemas 1
SELECT CAST('COUNT' AS VARCHAR(10)) AS COUNT, [mac], [ipad], [charger]
FROM (
    SELECT [o].employeeName, [p].productName
    FROM dbo.orders [o] JOIN products AS [p] on ([o].productId = [p].productId)
) AS dervied_table
PIVOT(
     COUNT(employeeName)
     FOR productName IN ([mac], [iphone], [ipad], [charger])
) as pvt
GO
~~START~~
varchar#!#int#!#int#!#int
COUNT#!#7#!#4#!#1
~~END~~


-- test pivot with table in different schemas 2
SELECT CAST('COUNT' AS VARCHAR(10)) AS COUNT, [mac], [ipad], [charger]
FROM (
    SELECT [o].employeeName, [p].productName
    FROM dbo.orders [o] JOIN pivot_schema.products_sch AS [p] on ([o].productId = [p].productId)
) AS dervied_table
PIVOT(
     COUNT(employeeName)
     FOR productName IN ([mac], [iphone], [ipad], [charger])
) as pvt
GO
~~START~~
varchar#!#int#!#int#!#int
COUNT#!#7#!#4#!#1
~~END~~

